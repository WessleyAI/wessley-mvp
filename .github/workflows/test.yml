name: Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.24"
      - run: go test ./... -count=1 -timeout=60s

  integration-tests:
    runs-on: ubuntu-latest
    services:
      neo4j:
        image: neo4j:5-community
        env:
          NEO4J_AUTH: none
        ports:
          - 7687:7687
          - 7474:7474
        options: >-
          --health-cmd "wget -qO- http://localhost:7474 || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 12
          --health-start-period 15s
      qdrant:
        image: qdrant/qdrant:v1.12.6
        ports:
          - 6333:6333
          - 6334:6334
        options: >-
          --health-cmd "wget -qO- http://localhost:6333/healthz || exit 1"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 10
      nats:
        image: nats:2.10-alpine
        ports:
          - 4222:4222
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.24"
      - name: Run integration tests
        env:
          NEO4J_URL: neo4j://localhost:7687
          QDRANT_URL: localhost:6334
          NATS_URL: nats://localhost:4222
        run: go test ./... -tags=integration -v -count=1 -timeout=120s
