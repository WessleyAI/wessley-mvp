<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Wessley AI ‚Äî Knowledge Base Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0f1117;--surface:#181a20;--surface2:#1e2028;--border:#2a2d38;
  --text:#e4e4e7;--text2:#9ca3af;--text3:#6b7280;
  --green:#22c55e;--amber:#f59e0b;--red:#ef4444;--blue:#3b82f6;--purple:#a78bfa;
  --cyan:#06b6d4;--orange:#f97316;
  --sidebar-w:240px;
}
html{font-family:'Inter',system-ui,sans-serif;font-size:14px;background:var(--bg);color:var(--text);-webkit-text-size-adjust:100%}
body{display:flex;min-height:100vh;min-height:100dvh}

/* ===== MOBILE-FIRST BASE (< 768px) ===== */

/* Sidebar: hidden by default on mobile */
.sidebar{width:var(--sidebar-w);background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;position:fixed;top:0;left:0;bottom:0;z-index:100;transition:transform .25s ease;transform:translateX(-100%)}
.sidebar.open{transform:translateX(0)}
.sidebar-header{padding:20px 16px 12px;border-bottom:1px solid var(--border)}
.sidebar-header h1{font-size:16px;font-weight:700;display:flex;align-items:center;gap:8px}
.sidebar-header h1 span{color:var(--amber)}
.sidebar-health{padding:10px 16px;font-size:12px;color:var(--text2);display:flex;align-items:center;gap:8px}
.sidebar-health .dot{width:10px;height:10px;border-radius:50%;background:var(--green);display:inline-block;flex-shrink:0}
.sidebar nav{flex:1;padding:12px 0;overflow-y:auto;-webkit-overflow-scrolling:touch}
.nav-group{padding:0 12px;margin-bottom:16px}
.nav-group-label{font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.08em;color:var(--text3);margin-bottom:6px;padding-left:4px}
.nav-item{display:flex;align-items:center;gap:10px;padding:12px 14px;border-radius:8px;cursor:pointer;font-size:14px;color:var(--text2);transition:all .15s;user-select:none;-webkit-tap-highlight-color:transparent;min-height:44px}
.nav-item:hover{background:var(--surface2);color:var(--text)}
.nav-item:active{background:rgba(59,130,246,.08)}
.nav-item.active{background:rgba(59,130,246,.12);color:var(--blue)}
.nav-item .icon{width:20px;text-align:center;font-size:16px;flex-shrink:0}
.sidebar-footer{padding:14px 16px;border-top:1px solid var(--border);font-size:12px;color:var(--text3)}
.sidebar-footer .countdown{display:flex;align-items:center;gap:8px}

/* Hamburger: visible on mobile */
.hamburger{display:flex;align-items:center;justify-content:center;position:fixed;top:10px;left:10px;z-index:200;background:var(--surface);border:1px solid var(--border);border-radius:8px;width:44px;height:44px;cursor:pointer;color:var(--text);font-size:20px;-webkit-tap-highlight-color:transparent}
.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:99;-webkit-tap-highlight-color:transparent}
.overlay.open{display:block}

/* Main: full width on mobile */
.main{flex:1;padding:16px;padding-top:62px;min-width:0;max-width:100vw;overflow-x:hidden}

/* Tabs: scrollable on mobile */
.tabs{display:flex;gap:0;margin-bottom:16px;border-bottom:1px solid var(--border);overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none}
.tabs::-webkit-scrollbar{display:none}
.tab{padding:10px 16px;font-size:13px;color:var(--text3);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-1px;transition:all .15s;white-space:nowrap;min-height:44px;display:flex;align-items:center;-webkit-tap-highlight-color:transparent}
.tab:hover{color:var(--text2)}
.tab.active{color:var(--blue);border-bottom-color:var(--blue)}

/* KPI cards: single column mobile */
.kpi-grid{display:grid;grid-template-columns:1fr;gap:12px;margin-bottom:16px}
.kpi-card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:14px 16px}
.kpi-card .label{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--text3);margin-bottom:4px}
.kpi-card .value{font-size:26px;font-weight:700;line-height:1.1}
.kpi-card .trend{font-size:12px;margin-left:6px}
.kpi-card .context{font-size:12px;color:var(--text2);margin-top:4px}

/* Story */
.story{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:16px;margin-bottom:16px;font-size:14px;line-height:1.6;color:var(--text2)}
.story strong{color:var(--text);font-weight:600}

/* Health strip: stack on mobile */
.health-strip{display:flex;flex-direction:column;gap:8px;margin-bottom:16px}
.health-pill{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:12px 16px;font-size:13px;display:flex;align-items:center;gap:10px}
.health-pill .dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}
.health-pill .dot.green{background:var(--green)}.health-pill .dot.amber{background:var(--amber)}.health-pill .dot.red{background:var(--red)}
.health-pill .hl{font-weight:600;color:var(--text)}

/* Insights */
.insights{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:14px 16px;margin-bottom:16px}
.insights h3{font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--text3);margin-bottom:10px}
.insight-item{display:flex;align-items:flex-start;gap:10px;padding:8px 0;font-size:13px;color:var(--text2);line-height:1.5}
.insight-item+.insight-item{border-top:1px solid var(--border)}
.insight-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;margin-top:4px}

/* Columns: stack on mobile */
.cols-2{display:grid;grid-template-columns:1fr;gap:14px;margin-bottom:16px}
.panel{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:14px 16px}
.panel h3{font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--text3);margin-bottom:10px}

/* Chart containers ‚Äî FIXED HEIGHT, always */
.chart-wrap{position:relative;height:200px}
.chart-wrap canvas{position:absolute;inset:0}

/* Stacked bar */
.source-bar{display:flex;height:36px;border-radius:6px;overflow:hidden;margin-bottom:10px}
.source-bar .seg{display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:600;color:#fff;min-width:20px;transition:width .3s}
.source-legend{display:flex;flex-wrap:wrap;gap:10px;font-size:12px;color:var(--text2)}
.source-legend span{display:flex;align-items:center;gap:4px}
.source-legend .swatch{width:10px;height:10px;border-radius:2px;display:inline-block}

/* Pipeline: scroll horizontally on mobile */
.pipeline{display:flex;align-items:center;gap:0;margin-bottom:16px;overflow-x:auto;-webkit-overflow-scrolling:touch;padding:12px 0;scrollbar-width:none}
.pipeline::-webkit-scrollbar{display:none}
.pipe-stage{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:12px 14px;text-align:center;min-width:110px;flex-shrink:0}
.pipe-stage .name{font-size:10px;font-weight:600;text-transform:uppercase;color:var(--text3);margin-bottom:4px}
.pipe-stage .val{font-size:18px;font-weight:700}
.pipe-stage .sub{font-size:10px;color:var(--text3);margin-top:2px}
.pipe-arrow{font-size:16px;color:var(--text3);padding:0 4px;flex-shrink:0}

/* Stats grid: 2 columns on mobile */
.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px}
.stat-box{background:var(--surface2);border-radius:8px;padding:12px;text-align:center}
.stat-box .num{font-size:20px;font-weight:700}
.stat-box .lbl{font-size:11px;color:var(--text3);margin-top:4px}

/* Source cards: single column on mobile */
.source-cards{display:grid;grid-template-columns:1fr;gap:12px;margin-bottom:16px}
.source-card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:14px 16px}
.source-card .head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.source-card .head .name{font-weight:600;font-size:14px;text-transform:uppercase;letter-spacing:.03em}
.source-card .head .status{font-size:12px;display:flex;align-items:center;gap:5px}
.source-card .count{font-size:22px;font-weight:700;margin-bottom:6px}
.source-card .bar-bg{height:6px;background:var(--surface2);border-radius:3px;overflow:hidden;margin-bottom:8px}
.source-card .bar-fill{height:100%;border-radius:3px;transition:width .3s}
.source-card .meta{font-size:12px;color:var(--text3);line-height:1.6}

/* Alert banner */
.alert-banner{padding:12px 14px;border-radius:8px;font-size:13px;margin-bottom:14px;display:flex;align-items:flex-start;gap:8px;line-height:1.5}
.alert-banner.warn{background:rgba(245,158,11,.1);border:1px solid rgba(245,158,11,.25);color:var(--amber)}
.alert-banner.info{background:rgba(59,130,246,.1);border:1px solid rgba(59,130,246,.25);color:var(--blue)}

/* Tables: horizontal scroll on mobile */
.data-table{width:100%;border-collapse:collapse;font-size:13px}
.data-table th{text-align:left;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--text3);padding:10px 12px;border-bottom:1px solid var(--border);white-space:nowrap}
.data-table td{padding:10px 12px;border-bottom:1px solid var(--border);color:var(--text2);white-space:nowrap}
.data-table tr:last-child td{border-bottom:none}
.cov-bar{display:inline-block;height:8px;border-radius:4px;background:var(--blue);vertical-align:middle}
.table-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch;margin:0 -16px;padding:0 16px}

/* Topology */
.topology{padding:16px 0;text-align:center;overflow-x:auto}
.topo-row{display:flex;justify-content:center;align-items:center;gap:6px;margin-bottom:8px;flex-wrap:wrap}
.topo-node{background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:8px 10px;font-size:11px;text-align:center}
.topo-node .cnt{font-weight:700;color:var(--blue)}
.topo-node.empty .cnt{color:var(--text3)}
.topo-arrow{color:var(--text3);font-size:14px}
.topo-varrow{color:var(--text3);font-size:14px;margin:4px 0}

/* Infra cards: single column on mobile */
.infra-cards{display:grid;grid-template-columns:1fr;gap:12px;margin-bottom:16px}
.infra-card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:14px 16px}
.infra-card .title{font-weight:600;font-size:14px;margin-bottom:8px;display:flex;align-items:center;gap:8px}
.infra-card .detail{font-size:12px;color:var(--text3);line-height:1.8}
.infra-card .detail strong{color:var(--text2);font-weight:500}

/* Manual empty state */
.manual-empty{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:24px 16px;text-align:center;max-width:500px;margin:0 auto}
.manual-empty h3{font-size:16px;margin-bottom:16px}
.manual-funnel{display:flex;justify-content:center;align-items:center;gap:12px;margin-bottom:20px;flex-wrap:wrap}
.funnel-step{text-align:center}
.funnel-step .circle{width:40px;height:40px;border-radius:50%;border:2px solid var(--border);display:flex;align-items:center;justify-content:center;margin:0 auto 6px;font-size:16px;font-weight:700;color:var(--text3)}
.funnel-step .lbl{font-size:10px;color:var(--text3);text-transform:uppercase}
.funnel-line{width:20px;height:2px;background:var(--border);margin-bottom:20px}
.manual-empty p{font-size:13px;color:var(--text2);line-height:1.6;margin-bottom:8px}
.manual-empty code{background:var(--surface2);padding:2px 8px;border-radius:4px;font-size:12px}

/* Logs */
.log-filters{display:flex;gap:6px;margin-bottom:14px;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none}
.log-filters::-webkit-scrollbar{display:none}
.log-filter{padding:8px 14px;font-size:12px;border-radius:6px;cursor:pointer;background:var(--surface2);color:var(--text3);border:none;white-space:nowrap;min-height:36px;-webkit-tap-highlight-color:transparent}
.log-filter.active{background:rgba(59,130,246,.15);color:var(--blue)}
.log-item{display:flex;gap:10px;padding:12px 0;border-bottom:1px solid var(--border);font-size:13px;align-items:flex-start}
.log-item .time{color:var(--text3);font-size:11px;min-width:50px;flex-shrink:0}
.log-badge{font-size:10px;padding:3px 8px;border-radius:10px;font-weight:600;flex-shrink:0}
.empty-state{text-align:center;padding:40px 16px;color:var(--text3);font-size:13px}

/* Summary line */
.summary-line{font-size:13px;color:var(--text2);margin-bottom:14px;line-height:1.5}

/* View title */
.view-title{font-size:20px;font-weight:700;margin-bottom:4px}
.view-subtitle{font-size:13px;color:var(--text3);margin-bottom:16px}

/* Hidden views */
.view{display:none}.view.active{display:block}
.tab-content{display:none}.tab-content.active{display:block}

/* ===== TABLET: ‚â• 600px ===== */
@media(min-width:600px){
  .kpi-grid{grid-template-columns:1fr 1fr}
  .stats-grid{grid-template-columns:repeat(3,1fr)}
  .source-cards{grid-template-columns:1fr 1fr}
  .infra-cards{grid-template-columns:1fr 1fr}
  .health-strip{flex-direction:row}
  .chart-wrap{height:220px}
}

/* ===== DESKTOP: ‚â• 1024px ===== */
@media(min-width:1024px){
  .sidebar{transform:translateX(0)}
  .hamburger{display:none}
  .overlay{display:none !important}
  .main{margin-left:var(--sidebar-w);padding:24px 28px;padding-top:24px}
  .kpi-grid{grid-template-columns:repeat(4,1fr)}
  .cols-2{grid-template-columns:1fr 1fr}
  .infra-cards{grid-template-columns:repeat(3,1fr)}
  .chart-wrap{height:240px}
  .kpi-card .value{font-size:30px}
  .nav-item{padding:8px 14px;font-size:13px;min-height:38px}
}

/* ===== LARGE DESKTOP: ‚â• 1400px ===== */
@media(min-width:1400px){
  .main{padding:28px 40px}
  .kpi-card .value{font-size:32px}
}
</style>
</head>
<body>

<div class="hamburger" onclick="document.querySelector('.sidebar').classList.toggle('open');document.querySelector('.overlay').classList.toggle('open')">‚ò∞</div>
<div class="overlay" onclick="document.querySelector('.sidebar').classList.remove('open');document.querySelector('.overlay').classList.remove('open')"></div>

<aside class="sidebar">
  <div class="sidebar-header">
    <h1><span>‚ö°</span> Wessley AI</h1>
  </div>
  <div class="sidebar-health"><span class="dot" id="sidebarDot"></span><span id="sidebarHealth">System Healthy</span></div>
  <nav>
    <div class="nav-group">
      <div class="nav-group-label">Command Center</div>
      <div class="nav-item active" data-view="overview"><span class="icon">üìä</span>Overview</div>
    </div>
    <div class="nav-group">
      <div class="nav-group-label">Data Pipeline</div>
      <div class="nav-item" data-view="ingestion"><span class="icon">üîÑ</span>Ingestion</div>
      <div class="nav-item" data-view="sources"><span class="icon">üï∑Ô∏è</span>Sources</div>
    </div>
    <div class="nav-group">
      <div class="nav-group-label">Knowledge Base</div>
      <div class="nav-item" data-view="graph"><span class="icon">üß†</span>Graph</div>
      <div class="nav-item" data-view="vehicles"><span class="icon">üöó</span>Vehicles</div>
      <div class="nav-item" data-view="manuals"><span class="icon">üìñ</span>Manuals</div>
    </div>
    <div class="nav-group">
      <div class="nav-group-label">System</div>
      <div class="nav-item" data-view="infra"><span class="icon">üñ•Ô∏è</span>Infrastructure</div>
      <div class="nav-item" data-view="logs"><span class="icon">üìã</span>Logs</div>
    </div>
  </nav>
  <div class="sidebar-footer">
    <div class="countdown">‚ñº Next sync: <span id="countdown">--:--</span></div>
  </div>
</aside>

<main class="main">

<!-- OVERVIEW -->
<div class="view active" id="v-overview">
  <div class="view-title">Mission Control</div>
  <div class="view-subtitle">Automotive knowledge base at a glance</div>
  <div class="story" id="storyText"></div>
  <div class="health-strip" id="healthStrip"></div>
  <div class="kpi-grid" id="kpiGrid"></div>
  <div class="insights" id="insightsPanel"><h3>Insights & Actions</h3><div id="insightsList"></div></div>
  <div class="cols-2">
    <div class="panel"><h3>Source Mix</h3><div id="sourceMixBar"></div></div>
    <div class="panel"><h3>Top Makes by Coverage</h3><div class="chart-wrap"><canvas id="chartMakes"></canvas></div></div>
  </div>
</div>

<!-- INGESTION -->
<div class="view" id="v-ingestion">
  <div class="view-title">Ingestion Pipeline</div>
  <div class="view-subtitle">Data flow from sources to knowledge</div>
  <div class="tabs">
    <div class="tab active" data-tab="ing-overview" data-group="ing">Overview</div>
    <div class="tab" data-tab="ing-throughput" data-group="ing">Throughput</div>
    <div class="tab" data-tab="ing-errors" data-group="ing">Errors</div>
  </div>
  <div class="tab-content active" id="tc-ing-overview">
    <div class="pipeline" id="pipelineFlow"></div>
    <div class="stats-grid" id="ingStats"></div>
  </div>
  <div class="tab-content" id="tc-ing-throughput">
    <div class="panel"><h3>Documents Ingested Over Time</h3><div class="chart-wrap"><canvas id="chartThroughput"></canvas></div><div id="throughputMsg" class="empty-state" style="display:none"></div></div>
  </div>
  <div class="tab-content" id="tc-ing-errors">
    <div class="panel"><h3>Error Rate</h3><div id="errorSummary" style="margin-bottom:16px"></div><div class="chart-wrap"><canvas id="chartErrors"></canvas></div></div>
  </div>
</div>

<!-- SOURCES -->
<div class="view" id="v-sources">
  <div class="view-title">Sources</div>
  <div class="view-subtitle">Scraper status and performance</div>
  <div class="summary-line" id="sourcesSummary"></div>
  <div class="source-cards" id="sourceCards"></div>
  <div class="panel"><h3>Source Comparison</h3><div class="chart-wrap"><canvas id="chartSourceComp"></canvas></div></div>
</div>

<!-- GRAPH -->
<div class="view" id="v-graph">
  <div class="view-title">Knowledge Graph</div>
  <div class="view-subtitle">Neo4j graph structure and growth</div>
  <div class="tabs">
    <div class="tab active" data-tab="graph-overview" data-group="graph">Overview</div>
    <div class="tab" data-tab="graph-topology" data-group="graph">Topology</div>
    <div class="tab" data-tab="graph-growth" data-group="graph">Growth</div>
  </div>
  <div class="tab-content active" id="tc-graph-overview">
    <div id="graphAlert"></div>
    <div class="kpi-grid" id="graphKpis"></div>
    <div class="cols-2">
      <div class="panel"><h3>Nodes by Type</h3><div class="chart-wrap"><canvas id="chartNodeTypes"></canvas></div></div>
      <div class="panel"><h3>Top Makes</h3><div class="table-wrap"><table class="data-table" id="graphMakesTable"></table></div></div>
    </div>
  </div>
  <div class="tab-content" id="tc-graph-topology">
    <div class="panel">
      <h3>Target Graph Schema</h3>
      <div class="topology" id="topoView"></div>
    </div>
  </div>
  <div class="tab-content" id="tc-graph-growth">
    <div class="panel"><h3>Nodes Over Time</h3><div class="chart-wrap"><canvas id="chartNodeGrowth"></canvas></div><div id="growthMsg" class="empty-state" style="display:none"></div></div>
  </div>
</div>

<!-- VEHICLES -->
<div class="view" id="v-vehicles">
  <div class="view-title">Vehicle Coverage</div>
  <div class="view-subtitle" id="vehicleSub"></div>
  <div class="panel" style="margin-bottom:20px"><h3>Coverage by Make</h3><div class="table-wrap"><table class="data-table" id="vehicleMakeTable"></table></div></div>
  <div class="panel"><h3>Top Vehicles</h3><div class="table-wrap"><table class="data-table" id="vehicleTopTable"></table></div></div>
</div>

<!-- MANUALS -->
<div class="view" id="v-manuals">
  <div class="view-title">Manual Tracker</div>
  <div class="view-subtitle">Owner & service manual discovery</div>
  <div id="manualsContent"></div>
</div>

<!-- INFRASTRUCTURE -->
<div class="view" id="v-infra">
  <div class="view-title">Infrastructure</div>
  <div class="view-subtitle">Service health and connectivity</div>
  <div class="infra-cards" id="infraCards"></div>
  <div class="panel"><h3>Pipeline Processes</h3><div class="table-wrap"><table class="data-table" id="processTable"></table></div></div>
</div>

<!-- LOGS -->
<div class="view" id="v-logs">
  <div class="view-title">Activity Log</div>
  <div class="view-subtitle">Recent pipeline activity</div>
  <div id="logsContent"></div>
</div>

</main>

<script>
/* State */
let DATA=null, HIST=[], _ts=null, currentView='overview', syncInterval=300, syncCountdown=300;
const charts={};
const SRC_COLORS={reddit:'#f97316',nhtsa:'#3b82f6',youtube:'#ef4444',forums:'#a78bfa',ifixit:'#22c55e'};
const SRC_NAMES={reddit:'Reddit',nhtsa:'NHTSA',youtube:'YouTube',forums:'Forums',ifixit:'iFixit'};

/* Chart helper */
function mkChart(id,cfg){
  if(charts[id]){charts[id].destroy();charts[id]=null}
  const el=document.getElementById(id);if(!el)return;
  charts[id]=new Chart(el,{...cfg,options:{responsive:true,maintainAspectRatio:false,animation:{duration:300},plugins:{legend:{display:false}},...cfg.options}});
}

/* Nav */
document.querySelectorAll('.nav-item').forEach(el=>{
  el.addEventListener('click',()=>{
    document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
    el.classList.add('active');
    currentView=el.dataset.view;
    document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
    document.getElementById('v-'+currentView).classList.add('active');
    renderView();
    document.querySelector('.sidebar').classList.remove('open');
    document.querySelector('.overlay').classList.remove('open');
  });
});

/* Tabs */
document.querySelectorAll('.tab').forEach(el=>{
  el.addEventListener('click',()=>{
    const g=el.dataset.group;
    document.querySelectorAll(`.tab[data-group="${g}"]`).forEach(t=>t.classList.remove('active'));
    el.classList.add('active');
    document.querySelectorAll(`.tab-content`).forEach(tc=>{
      if(tc.id===`tc-${el.dataset.tab}`)tc.classList.add('active');
      else if(tc.id.startsWith(`tc-${g}`))tc.classList.remove('active');
    });
    renderView();
  });
});

/* Insights */
function generateInsights(d){
  const ins=[];
  const kg=d.knowledge_graph,ing=d.ingestion,sc=d.scrapers;
  if(kg.total_relationships===0&&kg.total_nodes>0)ins.push({level:'error',msg:'Vehicle graph has 0 relationships ‚Äî enricher needs to run to build Make ‚Üí Model ‚Üí Component connections'});
  if(sc.manuals.discovered===0)ins.push({level:'warn',msg:'Manual crawler not started ‚Äî 0 PDFs discovered from 30+ manufacturer portals'});
  const total=ing.total_docs_ingested;
  for(const[src,count]of Object.entries(ing.docs_by_source)){
    if(count<total*0.02)ins.push({level:'warn',msg:`${SRC_NAMES[src]||src} has only ${count} docs (${(count/total*100).toFixed(1)}%) ‚Äî consider adding more search queries`});
  }
  const sorted=Object.entries(ing.docs_by_source).sort((a,b)=>b[1]-a[1]);
  const maxSrc=sorted[0];
  if(maxSrc&&maxSrc[1]>total*0.7)ins.push({level:'info',msg:`${SRC_NAMES[maxSrc[0]]} is the primary source at ${(maxSrc[1]/total*100).toFixed(0)}% of corpus ‚Äî performing well`});
  const infra=d.infrastructure;
  const allUp=Object.values(infra).every(s=>s.status==='connected');
  if(allUp)ins.push({level:'ok',msg:'All 3 infrastructure services connected and operational'});
  const errRate=total>0?ing.total_errors/total:0;
  if(errRate<0.02)ins.push({level:'ok',msg:`Error rate ${(errRate*100).toFixed(1)}% ‚Äî within tolerance (${ing.total_errors} of ${total})`});
  else if(errRate<0.05)ins.push({level:'warn',msg:`Error rate ${(errRate*100).toFixed(1)}% ‚Äî elevated, monitor closely`});
  else ins.push({level:'error',msg:`Error rate ${(errRate*100).toFixed(1)}% ‚Äî high, investigate pipeline`});
  return ins.sort((a,b)=>{const o={error:0,warn:1,info:2,ok:3};return(o[a.level]??9)-(o[b.level]??9)});
}

function insightColor(level){return{error:'var(--red)',warn:'var(--amber)',info:'var(--blue)',ok:'var(--green)'}[level]||'var(--text3)'}

/* Render functions */
function renderOverview(){
  if(!DATA)return;
  const d=DATA,ing=d.ingestion,kg=d.knowledge_graph,sc=d.scrapers;
  const total=ing.total_docs_ingested;
  const makes=kg.top_makes.length;
  const vehicles=kg.top_vehicles.length;
  const activeSrc=Object.entries(sc).filter(([k,v])=>k!=='manuals'&&v.status==='running').length;
  const allUp=Object.values(d.infrastructure).every(s=>s.status==='connected');

  // Growth rate from history
  let growthRate='';
  if(HIST.length>=2){const oldest=HIST[0],newest=HIST[HIST.length-1];const dt=(new Date(newest.timestamp)-new Date(oldest.timestamp))/3600000;const dd=newest.total_docs-oldest.total_docs;if(dt>0)growthRate=` Knowledge is growing at <strong>~${Math.round(dd/dt)} docs/hour</strong>.`}

  // Story
  const topMake=kg.top_makes[0];
  document.getElementById('storyText').innerHTML=`Wessley knows about <strong>${total.toLocaleString()}</strong> repair topics across <strong>${makes} makes</strong> and <strong>${vehicles}+ vehicles</strong>, sourced from <strong>${activeSrc} active crawlers</strong>.${growthRate} ${allUp?'All systems operational.':'<span style="color:var(--amber)">Some systems need attention.</span>'} ${topMake?`<strong>${topMake.name}</strong> has the deepest coverage with ${topMake.documents} documents.`:''}`;

  // Health
  const errRate=total>0?ing.total_errors/total:0;
  const pipeH=errRate<0.05?'green':'amber';
  const knowH=total>0?(HIST.length>1&&HIST[HIST.length-1].total_docs>HIST[0].total_docs?'green':'amber'):(total>0?'amber':'red');
  const infraH=allUp?'green':'amber';
  document.getElementById('healthStrip').innerHTML=`
    <div class="health-pill"><span class="dot ${pipeH}"></span>Pipeline: <span class="hl">${pipeH==='green'?'Healthy':'Degraded'}</span></div>
    <div class="health-pill"><span class="dot ${knowH==='green'?'green':'amber'}"></span>Knowledge: <span class="hl">${total===0?'Empty':knowH==='green'?'Growing':'Building'}</span></div>
    <div class="health-pill"><span class="dot ${infraH}"></span>Infrastructure: <span class="hl">${allUp?'All Connected':'Partial'}</span></div>`;

  // KPIs
  const topM=kg.top_makes[0];
  document.getElementById('kpiGrid').innerHTML=`
    <div class="kpi-card"><div class="label">Knowledge Base</div><div class="value">${total.toLocaleString()}<span class="trend" style="color:var(--green)">‚Üí</span></div><div class="context">across ${makes} makes, ${activeSrc} sources</div></div>
    <div class="kpi-card"><div class="label">Embeddings</div><div class="value">${d.vector_store.total_vectors.toLocaleString()}</div><div class="context">${d.vector_store.dimensions}-dim, Qdrant ${d.vector_store.status}</div></div>
    <div class="kpi-card"><div class="label">Error Rate</div><div class="value">${(errRate*100).toFixed(1)}%</div><div class="context">${ing.total_errors} of ${total} ‚Äî ${errRate<0.02?'within tolerance':'elevated'}</div></div>
    <div class="kpi-card"><div class="label">Coverage</div><div class="value">${makes} makes</div><div class="context">${topM?topM.name+' leads with '+topM.documents+' docs':''}</div></div>`;

  // Insights
  const insights=generateInsights(d);
  document.getElementById('insightsList').innerHTML=insights.map(i=>`<div class="insight-item"><span class="insight-dot" style="background:${insightColor(i.level)}"></span>${i.msg}</div>`).join('');

  // Source mix bar
  const srcEntries=Object.entries(ing.docs_by_source).sort((a,b)=>b[1]-a[1]);
  let barHtml='<div class="source-bar">';
  srcEntries.forEach(([k,v])=>{const pct=(v/total*100);barHtml+=`<div class="seg" style="width:${pct}%;background:${SRC_COLORS[k]||'#666'}">${pct>5?pct.toFixed(0)+'%':''}</div>`});
  barHtml+='</div><div class="source-legend">';
  srcEntries.forEach(([k,v])=>{barHtml+=`<span><span class="swatch" style="background:${SRC_COLORS[k]}"></span>${SRC_NAMES[k]||k} ${v.toLocaleString()} (${(v/total*100).toFixed(1)}%)</span>`});
  barHtml+='</div>';
  document.getElementById('sourceMixBar').innerHTML=barHtml;

  // Makes chart
  const top5=kg.top_makes.slice(0,5);
  mkChart('chartMakes',{type:'bar',data:{labels:top5.map(m=>m.name),datasets:[{data:top5.map(m=>m.documents),backgroundColor:'rgba(59,130,246,.7)',borderRadius:4}]},options:{indexAxis:'y',scales:{x:{grid:{color:'rgba(255,255,255,.05)'},ticks:{color:'#9ca3af'}},y:{grid:{display:false},ticks:{color:'#e4e4e7'}}}}});
}

function renderIngestion(){
  if(!DATA)return;
  const d=DATA,ing=d.ingestion;
  // Pipeline
  const stages=[
    {name:'Source Files',val:ing.files_processed,sub:'files'},
    {name:'Validate',val:ing.total_docs_ingested,sub:'docs'},
    {name:'Parse & Chunk',val:d.vector_store.total_vectors,sub:'chunks'},
    {name:'Embed (Ollama)',val:d.vector_store.total_vectors,sub:'embeddings'},
    {name:'Store',val:`${d.knowledge_graph.total_nodes}n + ${d.vector_store.total_vectors}v`,sub:'Neo4j + Qdrant'}
  ];
  document.getElementById('pipelineFlow').innerHTML=stages.map((s,i)=>`${i>0?'<div class="pipe-arrow">‚Üí</div>':''}<div class="pipe-stage"><div class="name">${s.name}</div><div class="val">${typeof s.val==='number'?s.val.toLocaleString():s.val}</div><div class="sub">${s.sub}</div></div>`).join('');

  document.getElementById('ingStats').innerHTML=`
    <div class="stat-box"><div class="num">${ing.total_docs_ingested.toLocaleString()}</div><div class="lbl">Total Ingested</div></div>
    <div class="stat-box"><div class="num">${ing.total_errors}</div><div class="lbl">Total Errors</div></div>
    <div class="stat-box"><div class="num">${ing.files_processed}</div><div class="lbl">Files Processed</div></div>
    <div class="stat-box"><div class="num">${d.vector_store.total_vectors.toLocaleString()}</div><div class="lbl">Chunks Created</div></div>
    <div class="stat-box"><div class="num">${d.vector_store.total_vectors.toLocaleString()}</div><div class="lbl">Embeddings</div></div>
    <div class="stat-box"><div class="num">‚Äî</div><div class="lbl">Avg Pipeline Time</div></div>`;

  // Throughput
  if(HIST.length<2){
    document.getElementById('chartThroughput').style.display='none';
    document.getElementById('throughputMsg').style.display='block';
    document.getElementById('throughputMsg').textContent='üìä Building history‚Ä¶ Data points appear every 5 minutes as the pipeline runs. Charts will populate automatically.';
  }else{
    document.getElementById('chartThroughput').style.display='';
    document.getElementById('throughputMsg').style.display='none';
    mkChart('chartThroughput',{type:'line',data:{labels:HIST.map(h=>new Date(h.timestamp).toLocaleTimeString()),datasets:[{data:HIST.map(h=>h.total_docs),borderColor:'var(--blue)',backgroundColor:'rgba(59,130,246,.1)',fill:true,tension:.3,pointRadius:2}]},options:{scales:{x:{grid:{color:'rgba(255,255,255,.05)'},ticks:{color:'#9ca3af',maxTicksLimit:10}},y:{grid:{color:'rgba(255,255,255,.05)'},ticks:{color:'#9ca3af'}}}}});
  }

  // Errors
  const errRate=ing.total_docs_ingested>0?(ing.total_errors/ing.total_docs_ingested*100).toFixed(1):0;
  document.getElementById('errorSummary').innerHTML=`<div style="font-size:13px;color:var(--text2)">${ing.total_errors} errors (${errRate}%) ‚Äî ${errRate<2?'all within acceptable range':'elevated, monitor closely'}</div>`;
  if(HIST.length>=2){
    mkChart('chartErrors',{type:'line',data:{labels:HIST.map(h=>new Date(h.timestamp).toLocaleTimeString()),datasets:[{data:HIST.map(h=>h.errors_delta||0),borderColor:'var(--red)',backgroundColor:'rgba(239,68,68,.1)',fill:true,tension:.3,pointRadius:2}]},options:{scales:{x:{grid:{color:'rgba(255,255,255,.05)'},ticks:{color:'#9ca3af',maxTicksLimit:10}},y:{grid:{color:'rgba(255,255,255,.05)'},ticks:{color:'#9ca3af'}}}}});
  }
}

function renderSources(){
  if(!DATA)return;
  const d=DATA,sc=d.scrapers,ing=d.ingestion;
  const total=ing.total_docs_ingested;
  const sources=['reddit','nhtsa','youtube','forums','ifixit'];
  const activeCnt=sources.filter(s=>sc[s]&&sc[s].status==='running').length;

  document.getElementById('sourcesSummary').innerHTML=`${activeCnt} of ${sources.length} sources active. ${Object.entries(ing.docs_by_source).sort((a,b)=>b[1]-a[1])[0]?SRC_NAMES[Object.entries(ing.docs_by_source).sort((a,b)=>b[1]-a[1])[0][0]]+' is the primary source.':''} Manual crawler not yet started.`;

  document.getElementById('sourceCards').innerHTML=sources.map(s=>{
    const info=sc[s]||{};
    const count=ing.docs_by_source[s]||0;
    const pct=total>0?(count/total*100):0;
    const lastScrape=info.last_scrape?timeAgo(new Date(info.last_scrape)):'-';
    return`<div class="source-card">
      <div class="head"><span class="name">${SRC_NAMES[s]||s}</span><span class="status"><span class="dot" style="width:6px;height:6px;border-radius:50%;background:${info.status==='running'?'var(--green)':'var(--text3)'}"></span>${info.status||'unknown'}</span></div>
      <div class="count">${count.toLocaleString()} <span style="font-size:13px;font-weight:400;color:var(--text3)">documents</span></div>
      <div class="bar-bg"><div class="bar-fill" style="width:${pct}%;background:${SRC_COLORS[s]}"></div></div>
      <div class="meta">${pct.toFixed(1)}% of corpus ¬∑ Last: ${lastScrape}</div>
    </div>`}).join('');

  const srcData=Object.entries(ing.docs_by_source).sort((a,b)=>b[1]-a[1]);
  mkChart('chartSourceComp',{type:'bar',data:{labels:srcData.map(([k])=>SRC_NAMES[k]||k),datasets:[{data:srcData.map(([,v])=>v),backgroundColor:srcData.map(([k])=>SRC_COLORS[k]||'#666'),borderRadius:4}]},options:{indexAxis:'y',scales:{x:{grid:{color:'rgba(255,255,255,.05)'},ticks:{color:'#9ca3af'}},y:{grid:{display:false},ticks:{color:'#e4e4e7'}}}}});
}

function renderGraph(){
  if(!DATA)return;
  const kg=DATA.knowledge_graph;

  // Alert
  if(kg.total_relationships===0&&kg.total_nodes>0){
    document.getElementById('graphAlert').innerHTML=`<div class="alert-banner warn">‚ö†Ô∏è Graph has no relationships yet. The enricher needs to process ingested documents to build vehicle ‚Üí system ‚Üí component connections.</div>`;
  }else{document.getElementById('graphAlert').innerHTML=''}

  // KPIs
  document.getElementById('graphKpis').innerHTML=`
    <div class="kpi-card"><div class="label">Nodes</div><div class="value">${kg.total_nodes.toLocaleString()}</div><div class="context">${Object.keys(kg.nodes_by_type).length} type(s)</div></div>
    <div class="kpi-card"><div class="label">Relationships</div><div class="value">${kg.total_relationships.toLocaleString()}</div><div class="context">${kg.total_relationships===0?'enricher pending':'active'}</div></div>
    <div class="kpi-card"><div class="label">Node Types</div><div class="value">${Object.keys(kg.nodes_by_type).length}</div><div class="context">${Object.keys(kg.nodes_by_type).join(', ')}</div></div>
    <div class="kpi-card"><div class="label">Makes Tracked</div><div class="value">${kg.top_makes.length}</div><div class="context">${kg.top_makes.slice(0,3).map(m=>m.name).join(', ')}‚Ä¶</div></div>`;

  // Node types chart
  const types=Object.entries(kg.nodes_by_type);
  mkChart('chartNodeTypes',{type:'bar',data:{labels:types.map(([k])=>k),datasets:[{data:types.map(([,v])=>v),backgroundColor:'rgba(167,139,250,.7)',borderRadius:4}]},options:{indexAxis:'y',scales:{x:{grid:{color:'rgba(255,255,255,.05)'},ticks:{color:'#9ca3af'}},y:{grid:{display:false},ticks:{color:'#e4e4e7'}}}}});

  // Makes table
  const maxDocs=kg.top_makes[0]?.documents||1;
  document.getElementById('graphMakesTable').innerHTML=`<thead><tr><th>Make</th><th>Models</th><th>Docs</th><th>Coverage</th></tr></thead><tbody>${kg.top_makes.map(m=>`<tr><td style="color:var(--text);font-weight:500">${m.name}</td><td>${m.models}</td><td>${m.documents}</td><td><span class="cov-bar" style="width:${(m.documents/maxDocs*100).toFixed(0)}%"></span></td></tr>`).join('')}</tbody>`;

  // Topology
  const nbt=kg.nodes_by_type;
  document.getElementById('topoView').innerHTML=`
    <div class="topo-row"><div class="topo-node empty"><div>Make</div><div class="cnt">0</div></div><span class="topo-arrow">‚Üí</span><div class="topo-node empty"><div>Model</div><div class="cnt">0</div></div><span class="topo-arrow">‚Üí</span><div class="topo-node empty"><div>Generation</div><div class="cnt">0</div></div><span class="topo-arrow">‚Üí</span><div class="topo-node empty"><div>Trim</div><div class="cnt">0</div></div></div>
    <div class="topo-varrow">‚Üì</div>
    <div class="topo-row"><div class="topo-node empty"><div>ModelYear</div><div class="cnt">0</div></div><span class="topo-arrow">‚Üí</span><div class="topo-node empty"><div>System</div><div class="cnt">0</div></div><span class="topo-arrow">‚Üí</span><div class="topo-node empty"><div>Subsystem</div><div class="cnt">0</div></div><span class="topo-arrow">‚Üí</span><div class="topo-node ${nbt.Component?'':'empty'}"><div>Component</div><div class="cnt">${nbt.Component||0}</div></div></div>
    <div class="topo-varrow">‚Üì</div>
    <div class="topo-row"><div class="topo-node empty"><div>Document</div><div class="cnt">0</div></div></div>
    <p style="margin-top:16px;font-size:12px;color:var(--text3)">Nodes highlighted in blue have data. The enricher will populate the full hierarchy.</p>`;

  // Growth
  if(HIST.length<5){
    document.getElementById('chartNodeGrowth').style.display='none';
    document.getElementById('growthMsg').style.display='block';
    document.getElementById('growthMsg').textContent='üìä Collecting data points‚Ä¶ Growth chart requires at least 5 history entries (25 minutes of pipeline activity).';
  }else{
    document.getElementById('chartNodeGrowth').style.display='';
    document.getElementById('growthMsg').style.display='none';
    mkChart('chartNodeGrowth',{type:'line',data:{labels:HIST.map(h=>new Date(h.timestamp).toLocaleTimeString()),datasets:[{label:'Nodes',data:HIST.map(h=>h.total_nodes),borderColor:'var(--purple)',tension:.3,pointRadius:2},{label:'Relationships',data:HIST.map(h=>h.total_relations||0),borderColor:'var(--cyan)',tension:.3,pointRadius:2}]},options:{scales:{x:{grid:{color:'rgba(255,255,255,.05)'},ticks:{color:'#9ca3af',maxTicksLimit:10}},y:{grid:{color:'rgba(255,255,255,.05)'},ticks:{color:'#9ca3af'}}},plugins:{legend:{display:true,labels:{color:'#9ca3af'}}}}});
  }
}

function renderVehicles(){
  if(!DATA)return;
  const kg=DATA.knowledge_graph;
  const maxDocs=kg.top_makes[0]?.documents||1;
  document.getElementById('vehicleSub').textContent=`Tracking ${kg.top_makes.length} makes, ${kg.top_vehicles.length}+ vehicles. ${kg.top_makes[0]?.name||''} has the deepest coverage.`;

  document.getElementById('vehicleMakeTable').innerHTML=`<thead><tr><th>Make</th><th>Models</th><th>Documents</th><th>Coverage Depth</th><th>Status</th></tr></thead><tbody>${kg.top_makes.map(m=>{
    const pct=m.documents/maxDocs*100;
    const status=pct>50?'üü¢ Good':pct>15?'üü° Moderate':'üü° Low';
    return`<tr><td style="color:var(--text);font-weight:500">${m.name}</td><td>${m.models}</td><td>${m.documents}</td><td><span class="cov-bar" style="width:${pct.toFixed(0)}%"></span></td><td>${status}</td></tr>`}).join('')}</tbody>`;

  document.getElementById('vehicleTopTable').innerHTML=`<thead><tr><th>Vehicle</th><th>Documents</th><th>Components</th><th>Systems Mapped</th></tr></thead><tbody>${kg.top_vehicles.map(v=>`<tr><td style="color:var(--text);font-weight:500">${v.vehicle}</td><td>${v.documents}</td><td>${v.components}</td><td style="color:var(--text3)">0 of 12</td></tr>`).join('')}</tbody>`;
}

function renderManuals(){
  if(!DATA)return;
  const m=DATA.scrapers.manuals;
  if(m.discovered===0){
    document.getElementById('manualsContent').innerHTML=`<div class="manual-empty">
      <h3>üìñ Manual Discovery</h3>
      <div class="manual-funnel">
        <div class="funnel-step"><div class="circle">0</div><div class="lbl">Discover</div></div>
        <div class="funnel-line"></div>
        <div class="funnel-step"><div class="circle">0</div><div class="lbl">Download</div></div>
        <div class="funnel-line"></div>
        <div class="funnel-step"><div class="circle">0</div><div class="lbl">Ingest</div></div>
        <div class="funnel-line"></div>
        <div class="funnel-step"><div class="circle">0</div><div class="lbl">Complete</div></div>
      </div>
      <p>The manual crawler hasn't been started yet.<br>It will scan <strong>30+ manufacturer portals</strong>:<br>Toyota, Honda, Ford, BMW, Mercedes, Chevrolet‚Ä¶</p>
      <p style="margin-top:12px">To start: <code>--manuals-discover</code></p>
      <p style="margin-top:12px;color:var(--text3)">Expected: 500‚Äì2,000 owner manuals covering 2015‚Äì2026 model years</p>
    </div>`;
  }else{
    document.getElementById('manualsContent').innerHTML=`<div class="manual-empty">
      <h3>üìñ Manual Discovery</h3>
      <div class="manual-funnel">
        <div class="funnel-step"><div class="circle">${m.discovered}</div><div class="lbl">Discover</div></div><div class="funnel-line"></div>
        <div class="funnel-step"><div class="circle">${m.downloaded}</div><div class="lbl">Download</div></div><div class="funnel-line"></div>
        <div class="funnel-step"><div class="circle">${m.ingested}</div><div class="lbl">Ingest</div></div><div class="funnel-line"></div>
        <div class="funnel-step"><div class="circle">${m.ingested}</div><div class="lbl">Complete</div></div>
      </div>
      ${m.failed>0?`<p style="color:var(--amber)">${m.failed} failed downloads</p>`:''}
    </div>`;
  }
}

function renderInfra(){
  if(!DATA)return;
  const infra=DATA.infrastructure,kg=DATA.knowledge_graph,vs=DATA.vector_store;
  document.getElementById('infraCards').innerHTML=`
    <div class="infra-card">
      <div class="title"><span class="dot" style="width:8px;height:8px;border-radius:50%;background:${infra.neo4j.status==='connected'?'var(--green)':'var(--red)'}"></span>Neo4j</div>
      <div class="detail"><strong>Status:</strong> ${infra.neo4j.status}<br><strong>Version:</strong> ${infra.neo4j.version}<br><strong>Nodes:</strong> ${kg.total_nodes.toLocaleString()}<br><strong>Relationships:</strong> ${kg.total_relationships.toLocaleString()}<br><strong>Port:</strong> 7687</div>
    </div>
    <div class="infra-card">
      <div class="title"><span class="dot" style="width:8px;height:8px;border-radius:50%;background:${infra.qdrant.status==='connected'?'var(--green)':'var(--red)'}"></span>Qdrant</div>
      <div class="detail"><strong>Status:</strong> ${infra.qdrant.status}<br><strong>Vectors:</strong> ${vs.total_vectors.toLocaleString()}<br><strong>Collection:</strong> ${vs.collection}<br><strong>Dimensions:</strong> ${vs.dimensions}<br><strong>Health:</strong> ${vs.status}</div>
    </div>
    <div class="infra-card">
      <div class="title"><span class="dot" style="width:8px;height:8px;border-radius:50%;background:${infra.ollama.status==='connected'?'var(--green)':'var(--red)'}"></span>Ollama</div>
      <div class="detail"><strong>Status:</strong> ${infra.ollama.status}<br><strong>Model:</strong> ${infra.ollama.model}<br><strong>Dimensions:</strong> ${vs.dimensions}<br><strong>Port:</strong> 11434</div>
    </div>`;

  document.getElementById('processTable').innerHTML=`<thead><tr><th>Process</th><th>Status</th><th>Interval</th></tr></thead><tbody>
    <tr><td>scraper-reddit</td><td style="color:var(--green)">‚óè Running</td><td>5 min</td></tr>
    <tr><td>scraper-nhtsa</td><td style="color:var(--green)">‚óè Running</td><td>30 min</td></tr>
    <tr><td>scraper-ifixit</td><td style="color:var(--green)">‚óè Running</td><td>30 min</td></tr>
    <tr><td>scraper-youtube</td><td style="color:var(--green)">‚óè Running</td><td>30 min</td></tr>
    <tr><td>ingest</td><td style="color:var(--green)">‚óè Running</td><td>30 sec</td></tr>
    <tr><td>enricher</td><td style="color:var(--text3)">‚óã Not started</td><td>‚Äî</td></tr>
    <tr><td>manual-crawler</td><td style="color:var(--text3)">‚óã Not started</td><td>‚Äî</td></tr>
  </tbody>`;
}

function renderLogs(){
  if(!HIST||HIST.length<=1){
    document.getElementById('logsContent').innerHTML=`<div class="empty-state" style="padding:60px 20px">
      <div style="font-size:24px;margin-bottom:12px">üìã</div>
      <div>Activity history is building. Entries appear every 5 minutes as the pipeline runs.</div>
      <div style="margin-top:8px;color:var(--text3)">Currently ${HIST.length} data point(s). Need at least 2 for delta computation.</div>
    </div>`;
    return;
  }
  let items=[];
  for(let i=HIST.length-1;i>=1;i--){
    const h=HIST[i],t=new Date(h.timestamp).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
    if(h.new_docs>0)items.push({t,cat:'ingestion',msg:`${h.new_docs} new documents ingested`});
    if(h.new_vectors>0)items.push({t,cat:'system',msg:`${h.new_vectors} new vectors embedded`});
    if(h.errors_delta>0)items.push({t,cat:'error',msg:`${h.errors_delta} new errors`});
    if(h.new_docs===0&&h.errors_delta===0)items.push({t,cat:'system',msg:'Pipeline idle ‚Äî no new activity'});
  }
  const catColors={ingestion:'var(--blue)',error:'var(--red)',system:'var(--text3)',source:'var(--orange)'};
  document.getElementById('logsContent').innerHTML=`<div class="log-filters"><button class="log-filter active">All</button><button class="log-filter">Ingestion</button><button class="log-filter">Errors</button><button class="log-filter">System</button></div>` + items.slice(0,50).map(i=>`<div class="log-item"><span class="time">${i.t}</span><span class="log-badge" style="background:${catColors[i.cat]||'var(--text3)'};color:#fff">${i.cat}</span><span>${i.msg}</span></div>`).join('');
}

function timeAgo(date){
  const s=Math.floor((Date.now()-date)/1000);
  if(s<60)return s+'s ago';if(s<3600)return Math.floor(s/60)+'m ago';if(s<86400)return Math.floor(s/3600)+'h ago';return Math.floor(s/86400)+'d ago';
}

/* Render dispatcher */
function renderView(){
  switch(currentView){
    case'overview':renderOverview();break;
    case'ingestion':renderIngestion();break;
    case'sources':renderSources();break;
    case'graph':renderGraph();break;
    case'vehicles':renderVehicles();break;
    case'manuals':renderManuals();break;
    case'infra':renderInfra();break;
    case'logs':renderLogs();break;
  }
  // Sidebar health
  if(DATA){
    const allUp=Object.values(DATA.infrastructure).every(s=>s.status==='connected');
    document.getElementById('sidebarDot').style.background=allUp?'var(--green)':'var(--amber)';
    document.getElementById('sidebarHealth').textContent=allUp?'System Healthy':'System Degraded';
  }
}

/* Load */
async function load(){
  const d=await fetch('data/metrics-latest.json?'+Date.now()).then(r=>r.json()).catch(()=>null);
  const h=await fetch('data/metrics-history.json?'+Date.now()).then(r=>r.json()).catch(()=>[]);
  if(!d||d.timestamp===_ts)return;
  _ts=d.timestamp;DATA=d;HIST=h;
  renderView();
}

/* Countdown */
setInterval(()=>{
  syncCountdown--;if(syncCountdown<=0){syncCountdown=syncInterval;load()}
  const m=Math.floor(syncCountdown/60),s=syncCountdown%60;
  document.getElementById('countdown').textContent=`${m}:${s.toString().padStart(2,'0')}`;
},1000);

load();
setInterval(load,60000);
</script>
</body>
</html>
