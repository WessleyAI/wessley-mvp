<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Wessley AI â€” Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
--bg:#0a0e14;--surface:#131920;--surface-hover:#1a2230;--border:#1e2a3a;
--text:#e2e8f0;--text2:#64748b;--blue:#3b82f6;--green:#22c55e;
--amber:#f59e0b;--red:#ef4444;--purple:#a78bfa;--sidebar-w:240px;
}
html{font-family:'Inter',system-ui,sans-serif;font-size:13px;color:var(--text);background:var(--bg);-webkit-font-smoothing:antialiased}
body{display:flex;min-height:100vh}
a{color:var(--blue);text-decoration:none}

/* Sidebar */
.sidebar{position:fixed;top:0;left:0;bottom:0;width:var(--sidebar-w);background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;z-index:100;transition:transform .25s}
.sidebar-header{padding:20px 16px 12px;border-bottom:1px solid var(--border)}
.sidebar-header .logo{display:flex;align-items:center;gap:10px;font-size:16px;font-weight:700;color:var(--text)}
.sidebar-header .logo svg{width:28px;height:28px}
.sidebar-header .live{display:flex;align-items:center;gap:6px;margin-top:10px;font-size:11px;color:var(--green)}
.sidebar-header .live .dot{width:7px;height:7px;border-radius:50%;background:var(--green);animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.sidebar-nav{flex:1;overflow-y:auto;padding:12px 0}
.nav-section{padding:0 16px;margin-bottom:4px;font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.08em;color:var(--text2);margin-top:16px}
.nav-section:first-child{margin-top:4px}
.nav-item{display:flex;align-items:center;gap:10px;padding:8px 16px;font-size:13px;font-weight:500;color:var(--text2);cursor:pointer;border-left:3px solid transparent;transition:all .15s}
.nav-item:hover{color:var(--text);background:var(--surface-hover)}
.nav-item.active{color:var(--text);background:rgba(59,130,246,.08);border-left-color:var(--blue)}
.nav-item svg{width:16px;height:16px;flex-shrink:0;opacity:.6}
.nav-item.active svg{opacity:1}

/* Countdown */
.sidebar-footer{padding:16px;border-top:1px solid var(--border);display:flex;flex-direction:column;align-items:center;gap:6px}
.countdown-ring{position:relative;width:56px;height:56px}
.countdown-ring svg{transform:rotate(-90deg)}
.countdown-ring circle{fill:none;stroke-width:3}
.countdown-ring .bg{stroke:var(--border)}
.countdown-ring .fg{stroke:var(--blue);stroke-linecap:round;transition:stroke-dashoffset 1s linear,stroke .3s}
.countdown-ring .fg.done{stroke:var(--green)}
.countdown-text{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:600;font-variant-numeric:tabular-nums}
.sidebar-footer .label{font-size:10px;color:var(--text2);text-transform:uppercase;letter-spacing:.05em}

/* Main */
.main{margin-left:var(--sidebar-w);flex:1;padding:24px 28px;min-width:0;transition:margin .25s}
.view{display:none;animation:fadeIn .25s}
.view.active{display:block}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}

/* Mobile */
.hamburger{display:none;position:fixed;top:12px;left:12px;z-index:200;width:36px;height:36px;border-radius:8px;background:var(--surface);border:1px solid var(--border);color:var(--text);font-size:18px;cursor:pointer;align-items:center;justify-content:center}
.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:99}
@media(max-width:768px){
.sidebar{transform:translateX(-100%)}
.sidebar.open{transform:translateX(0)}
.overlay.open{display:block}
.hamburger{display:flex}
.main{margin-left:0;padding:16px;padding-top:56px}
}

/* Components */
.kpi-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;margin-bottom:20px}
.card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px;transition:background .15s}
.card:hover{background:var(--surface-hover)}
.card-title{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.06em;color:var(--text2);margin-bottom:8px}
.card .big-num{font-size:36px;font-weight:700;font-variant-numeric:tabular-nums;line-height:1.1}
.card .delta{display:inline-flex;align-items:center;gap:3px;font-size:11px;font-weight:600;padding:2px 7px;border-radius:99px;margin-left:8px;vertical-align:middle}
.delta.up{background:rgba(34,197,94,.12);color:var(--green)}
.delta.down{background:rgba(239,68,68,.12);color:var(--red)}
.delta.neutral{background:rgba(100,116,139,.12);color:var(--text2)}
.sparkline{margin-top:8px}
.chart-row{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px}
.chart-row .card{min-height:280px}
.mini-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:20px}
.mini-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:14px 16px;display:flex;align-items:center;gap:12px}
.mini-card .icon{width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0}
.mini-card .info .label{font-size:11px;color:var(--text2)}
.mini-card .info .value{font-size:15px;font-weight:600}
.pill{display:inline-flex;align-items:center;padding:2px 10px;border-radius:99px;font-size:11px;font-weight:600}
.pill.green{background:rgba(34,197,94,.15);color:var(--green)}
.pill.red{background:rgba(239,68,68,.15);color:var(--red)}
.pill.amber{background:rgba(245,158,11,.15);color:var(--amber)}
.pill.blue{background:rgba(59,130,246,.15);color:var(--blue)}
.pill.gray{background:rgba(100,116,139,.15);color:var(--text2)}

/* Tables */
table{width:100%;border-collapse:collapse;font-size:13px}
th{text-align:left;padding:10px 12px;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--text2);border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--surface)}
td{padding:10px 12px;border-bottom:1px solid var(--border)}
tr:nth-child(even) td{background:rgba(255,255,255,.015)}
tr:hover td{background:var(--surface-hover)}

/* Activity Feed */
.feed-item{display:flex;gap:12px;padding:10px 0;border-bottom:1px solid var(--border);align-items:flex-start}
.feed-item .fi-icon{width:28px;height:28px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0;background:var(--surface-hover)}
.feed-item .fi-time{font-size:11px;color:var(--text2);white-space:nowrap;min-width:60px}
.feed-item .fi-msg{flex:1;line-height:1.5}
.feed-item.error{background:rgba(239,68,68,.04);border-radius:6px;padding:10px;margin:-2px -10px;border-bottom:none}
.feed-item .badge{font-size:10px;padding:1px 7px;border-radius:99px;background:var(--surface-hover);color:var(--text2);white-space:nowrap}

/* Filters */
.filters{display:flex;gap:6px;margin-bottom:16px;flex-wrap:wrap}
.filters button{padding:5px 14px;border-radius:99px;border:1px solid var(--border);background:transparent;color:var(--text2);font-size:12px;font-weight:500;cursor:pointer;transition:all .15s}
.filters button:hover{border-color:var(--text2);color:var(--text)}
.filters button.active{background:var(--blue);border-color:var(--blue);color:#fff}

/* Service cards */
.service-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:16px}
.svc-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:20px}
.svc-card .svc-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
.svc-card .svc-name{font-size:15px;font-weight:600}
.svc-card .svc-row{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border);font-size:12px}
.svc-card .svc-row:last-child{border-bottom:none}
.svc-card .svc-label{color:var(--text2)}

/* Pipeline flow */
.pipeline-flow{display:flex;align-items:center;gap:4px;padding:20px 0;overflow-x:auto;flex-wrap:wrap;justify-content:center}
.pipe-stage{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:14px 18px;text-align:center;min-width:100px}
.pipe-stage .stage-name{font-size:11px;font-weight:600;text-transform:uppercase;color:var(--text2);margin-bottom:4px}
.pipe-stage .stage-val{font-size:20px;font-weight:700}
.pipe-arrow{color:var(--text2);font-size:18px;flex-shrink:0}

/* Funnel */
.funnel{display:flex;flex-direction:column;gap:4px;max-width:500px;margin:0 auto 20px}
.funnel-step{display:flex;align-items:center;gap:12px;padding:12px 16px;border-radius:8px;font-weight:600;font-size:14px;color:#fff;justify-content:space-between}
.funnel-step .fs-num{font-size:24px;font-weight:700;font-variant-numeric:tabular-nums}

/* Search */
.search-bar{display:flex;gap:8px;margin-bottom:16px}
.search-bar input{flex:1;padding:8px 14px;border-radius:8px;border:1px solid var(--border);background:var(--surface);color:var(--text);font-size:13px;outline:none}
.search-bar input:focus{border-color:var(--blue)}

/* Section title */
.section-title{font-size:15px;font-weight:600;margin-bottom:14px;display:flex;align-items:center;gap:8px}
.section-title svg{width:18px;height:18px;opacity:.5}
.view-header{font-size:22px;font-weight:700;margin-bottom:20px}

/* Scraper cards */
.scraper-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px;margin-bottom:24px}
.scraper-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:18px}
.scraper-card .sc-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.scraper-card .sc-name{font-size:15px;font-weight:600;text-transform:capitalize}
.scraper-card .sc-row{display:flex;justify-content:space-between;padding:5px 0;font-size:12px}
.scraper-card .sc-label{color:var(--text2)}

/* Empty state */
.empty-state{text-align:center;padding:60px 20px;color:var(--text2)}
.empty-state svg{width:48px;height:48px;margin-bottom:12px;opacity:.3}
.empty-state p{font-size:14px}

/* Coverage heatmap */
.heatmap{display:grid;gap:2px;margin-bottom:20px}
.heatmap-cell{width:20px;height:20px;border-radius:3px;display:flex;align-items:center;justify-content:center;font-size:8px}

/* Tree */
.tree-item{padding:6px 0 6px 20px;cursor:pointer;border-bottom:1px solid var(--border)}
.tree-item:hover{background:var(--surface-hover)}
.tree-item .toggle{margin-right:6px;color:var(--text2)}
.tree-children{padding-left:16px}
</style>
</head>
<body>
<button class="hamburger" onclick="document.querySelector('.sidebar').classList.toggle('open');document.querySelector('.overlay').classList.toggle('open')">â˜°</button>
<div class="overlay" onclick="document.querySelector('.sidebar').classList.remove('open');this.classList.remove('open')"></div>

<nav class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <div class="logo">
      <svg viewBox="0 0 28 28" fill="none"><circle cx="14" cy="14" r="13" stroke="#3b82f6" stroke-width="2"/><path d="M8 14l4 4 8-8" stroke="#3b82f6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      Wessley AI
    </div>
    <div class="live"><span class="dot"></span> <span id="live-status">System Online</span></div>
  </div>
  <div class="sidebar-nav">
    <div class="nav-section">Overview</div>
    <div class="nav-item active" data-view="overview" onclick="go('overview')">
      <svg viewBox="0 0 16 16" fill="currentColor"><rect x="1" y="1" width="6" height="6" rx="1"/><rect x="9" y="1" width="6" height="6" rx="1"/><rect x="1" y="9" width="6" height="6" rx="1"/><rect x="9" y="9" width="6" height="6" rx="1"/></svg>
      Dashboard
    </div>
    <div class="nav-section">Pipeline</div>
    <div class="nav-item" data-view="ingestion" onclick="go('ingestion')">
      <svg viewBox="0 0 16 16" fill="currentColor"><path d="M2 3h12v2H2zM4 7h8v2H4zM6 11h4v2H6z"/></svg>
      Ingestion
    </div>
    <div class="nav-item" data-view="scrapers" onclick="go('scrapers')">
      <svg viewBox="0 0 16 16" fill="currentColor"><path d="M3 2a1 1 0 00-1 1v10a1 1 0 001 1h10a1 1 0 001-1V3a1 1 0 00-1-1H3zm2 3h6v1H5V5zm0 3h6v1H5V8zm0 3h4v1H5v-1z"/></svg>
      Scrapers
    </div>
    <div class="nav-item" data-view="manuals" onclick="go('manuals')">
      <svg viewBox="0 0 16 16" fill="currentColor"><path d="M2 2v12h12V2H2zm2 2h8v1H4V4zm0 3h8v1H4V7zm0 3h5v1H4v-1z"/></svg>
      Manuals
    </div>
    <div class="nav-section">Knowledge</div>
    <div class="nav-item" data-view="graph" onclick="go('graph')">
      <svg viewBox="0 0 16 16" fill="currentColor"><circle cx="4" cy="4" r="2"/><circle cx="12" cy="4" r="2"/><circle cx="8" cy="12" r="2"/><line x1="5.5" y1="5.5" x2="7" y2="10.5" stroke="currentColor" stroke-width="1.2"/><line x1="10.5" y1="5.5" x2="9" y2="10.5" stroke="currentColor" stroke-width="1.2"/></svg>
      Graph Explorer
    </div>
    <div class="nav-item" data-view="vehicles" onclick="go('vehicles')">
      <svg viewBox="0 0 16 16" fill="currentColor"><path d="M3 10l1-4h8l1 4M4 12a1 1 0 100-2 1 1 0 000 2zm8 0a1 1 0 100-2 1 1 0 000 2zM3 10h10"/></svg>
      Vehicles
    </div>
    <div class="nav-section">Infrastructure</div>
    <div class="nav-item" data-view="services" onclick="go('services')">
      <svg viewBox="0 0 16 16" fill="currentColor"><rect x="2" y="2" width="12" height="4" rx="1"/><rect x="2" y="10" width="12" height="4" rx="1"/><circle cx="5" cy="4" r="1"/><circle cx="5" cy="12" r="1"/></svg>
      Services
    </div>
    <div class="nav-section">Activity</div>
    <div class="nav-item" data-view="activity" onclick="go('activity')">
      <svg viewBox="0 0 16 16" fill="currentColor"><path d="M8 1a7 7 0 100 14A7 7 0 008 1zm0 3v4l3 2" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linecap="round"/></svg>
      Feed
    </div>
  </div>
  <div class="sidebar-footer">
    <div class="countdown-ring">
      <svg width="56" height="56" viewBox="0 0 56 56">
        <circle class="bg" cx="28" cy="28" r="24"/>
        <circle class="fg" id="cd-ring" cx="28" cy="28" r="24" stroke-dasharray="150.8" stroke-dashoffset="0"/>
      </svg>
      <div class="countdown-text" id="cd-text">5:00</div>
    </div>
    <div class="label">Next update</div>
  </div>
</nav>

<main class="main">
<!-- ===== OVERVIEW ===== -->
<div class="view active" id="v-overview">
  <div class="view-header">Dashboard</div>
  <div class="kpi-row" id="kpi-row"></div>
  <div class="chart-row">
    <div class="card"><div class="card-title">Ingestion Rate (24h)</div><canvas id="ch-ingestion" height="220"></canvas></div>
    <div class="card"><div class="card-title">Source Distribution</div><canvas id="ch-sources" height="220"></canvas></div>
  </div>
  <div class="mini-row" id="mini-row"></div>
  <div class="card"><div class="card-title">Recent Activity</div><div id="overview-feed"></div></div>
</div>

<!-- ===== INGESTION ===== -->
<div class="view" id="v-ingestion">
  <div class="view-header">Ingestion Pipeline</div>
  <div class="card" style="margin-bottom:20px"><div class="card-title">Pipeline Flow</div><div class="pipeline-flow" id="pipe-flow"></div></div>
  <div class="chart-row">
    <div class="card"><div class="card-title">Throughput Over Time</div><canvas id="ch-throughput" height="220"></canvas></div>
    <div class="card"><div class="card-title">Stage Breakdown</div><canvas id="ch-stages" height="220"></canvas></div>
  </div>
  <div class="kpi-row" style="grid-template-columns:repeat(auto-fit,minmax(150px,1fr))">
    <div class="card"><div class="card-title">Queue Depth</div><div class="big-num" id="queue-depth">0</div></div>
    <div class="card"><div class="card-title">Files Processed</div><div class="big-num" id="files-processed">0</div></div>
    <div class="card"><div class="card-title">Dedup Hit Rate</div><div class="big-num" id="dedup-rate">â€”</div></div>
    <div class="card"><div class="card-title">Errors</div><div class="big-num" style="color:var(--red)" id="ing-errors">0</div></div>
  </div>
  <div class="card"><div class="card-title">Recent Errors</div><div id="error-log"></div></div>
</div>

<!-- ===== SCRAPERS ===== -->
<div class="view" id="v-scrapers">
  <div class="view-header">Scrapers</div>
  <div class="scraper-grid" id="scraper-grid"></div>
  <div class="card"><div class="card-title">Documents by Source</div><canvas id="ch-by-source" height="260"></canvas></div>
</div>

<!-- ===== MANUALS ===== -->
<div class="view" id="v-manuals">
  <div class="view-header">Manuals</div>
  <div class="card" style="margin-bottom:20px"><div class="card-title">Discovery Funnel</div><div id="funnel"></div></div>
  <div class="kpi-row" style="grid-template-columns:repeat(auto-fit,minmax(140px,1fr));margin-bottom:20px">
    <div class="card"><div class="card-title">Total PDFs</div><div class="big-num" id="m-pdfs">0</div></div>
    <div class="card"><div class="card-title">Discovered</div><div class="big-num" id="m-disc">0</div></div>
    <div class="card"><div class="card-title">Downloaded</div><div class="big-num" id="m-dl">0</div></div>
    <div class="card"><div class="card-title">Failed</div><div class="big-num" style="color:var(--red)" id="m-fail">0</div></div>
  </div>
  <div class="card"><div class="card-title">Recent Manual Entries</div><div id="manuals-table"></div></div>
</div>

<!-- ===== GRAPH ===== -->
<div class="view" id="v-graph">
  <div class="view-header">Knowledge Graph</div>
  <div class="chart-row">
    <div class="card"><div class="card-title">Nodes by Type</div><canvas id="ch-nodes-type" height="220"></canvas></div>
    <div class="card"><div class="card-title">Graph Growth</div><canvas id="ch-graph-growth" height="220"></canvas></div>
  </div>
  <div class="card" style="margin-bottom:20px"><div class="card-title">Top Makes by Documents</div><canvas id="ch-top-makes" height="260"></canvas></div>
  <div class="card"><div class="card-title">Vehicle Hierarchy</div><div id="vehicle-tree"></div></div>
</div>

<!-- ===== VEHICLES ===== -->
<div class="view" id="v-vehicles">
  <div class="view-header">Vehicles</div>
  <div class="search-bar"><input type="text" id="veh-search" placeholder="Search vehicles..." oninput="filterVehicles()"></div>
  <div class="card" style="margin-bottom:20px"><div class="card-title">Top Vehicles by Coverage</div><canvas id="ch-top-vehicles" height="240"></canvas></div>
  <div class="card"><div class="card-title">All Vehicles</div><div style="overflow-x:auto" id="vehicles-table"></div></div>
</div>

<!-- ===== SERVICES ===== -->
<div class="view" id="v-services">
  <div class="view-header">Infrastructure</div>
  <div class="service-grid" id="services-grid"></div>
</div>

<!-- ===== ACTIVITY ===== -->
<div class="view" id="v-activity">
  <div class="view-header">Activity Feed</div>
  <div class="filters" id="activity-filters">
    <button class="active" data-filter="all" onclick="setFilter('all',this)">All</button>
    <button data-filter="ingestion" onclick="setFilter('ingestion',this)">Ingestion</button>
    <button data-filter="scrapers" onclick="setFilter('scrapers',this)">Scrapers</button>
    <button data-filter="errors" onclick="setFilter('errors',this)">Errors</button>
    <button data-filter="vehicles" onclick="setFilter('vehicles',this)">Vehicles</button>
  </div>
  <div id="activity-feed"></div>
</div>
</main>

<script>
// State
let D = null, H = [], charts = {}, cdLeft = 300, cdTimer = null, activeFilter = 'all';
const CIRC = 2 * Math.PI * 24; // ~150.8

// Helpers
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);
const fmt = n => n == null ? 'â€”' : n.toLocaleString();
function ago(ts) {
  if (!ts) return 'â€”';
  const d = (Date.now() - new Date(ts).getTime()) / 1000;
  if (d < 60) return 'just now';
  if (d < 3600) return Math.floor(d/60) + 'm ago';
  if (d < 86400) return Math.floor(d/3600) + 'h ago';
  return Math.floor(d/86400) + 'd ago';
}
function sparkSVG(data, w=80, h=24, color='#3b82f6') {
  if (!data || data.length < 2) return `<svg width="${w}" height="${h}"></svg>`;
  const max = Math.max(...data, 1), min = Math.min(...data, 0);
  const range = max - min || 1;
  const pts = data.map((v, i) => `${(i / (data.length - 1)) * w},${h - ((v - min) / range) * (h - 4) - 2}`).join(' ');
  return `<svg width="${w}" height="${h}" class="sparkline"><polyline points="${pts}" fill="none" stroke="${color}" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
}
function statusPill(s) {
  const c = s === 'running' || s === 'connected' ? 'green' : s === 'error' ? 'red' : s === 'stopped' ? 'amber' : 'gray';
  return `<span class="pill ${c}">${s}</span>`;
}

// Routing
function go(view) {
  location.hash = view;
}
function route() {
  const h = (location.hash || '#overview').slice(1) || 'overview';
  $$('.view').forEach(v => v.classList.remove('active'));
  const el = $(`#v-${h}`);
  if (el) el.classList.add('active');
  $$('.nav-item').forEach(n => {
    n.classList.toggle('active', n.dataset.view === h);
  });
  // Close mobile sidebar
  $('.sidebar').classList.remove('open');
  $('.overlay').classList.remove('open');
}
window.addEventListener('hashchange', route);

// Data loading
async function loadData() {
  try {
    const [lr, hr] = await Promise.all([
      fetch('data/metrics-latest.json').then(r => r.json()),
      fetch('data/metrics-history.json').then(r => r.json())
    ]);
    D = lr; H = hr;
    render();
  } catch(e) {
    console.error('Data load failed:', e);
  }
}

// Render all views
function render() {
  if (!D) return;
  renderOverview();
  renderIngestion();
  renderScrapers();
  renderManuals();
  renderGraph();
  renderVehicles();
  renderServices();
  renderActivity();
}

function renderOverview() {
  const ing = D.ingestion || {};
  const kg = D.knowledge_graph || {};
  const vs = D.vector_store || {};
  const errRate = ing.total_docs_ingested ? ((ing.total_errors / ing.total_docs_ingested) * 100).toFixed(1) + '%' : '0%';
  const histDocs = H.map(h => h.total_docs || 0);
  const histVecs = H.map(h => h.total_vectors || 0);
  const histNodes = H.map(h => h.total_nodes || 0);

  const kpis = [
    { title: 'Total Documents', value: fmt(ing.total_docs_ingested), spark: histDocs, delta: H.length ? H[H.length-1].new_docs : 0 },
    { title: 'Graph Nodes', value: fmt(kg.total_nodes), spark: histNodes, delta: H.length ? H[H.length-1].new_nodes : 0 },
    { title: 'Vectors', value: fmt(vs.total_vectors), spark: histVecs, delta: H.length ? H[H.length-1].new_vectors : 0 },
    { title: 'Error Rate', value: errRate, spark: H.map(h => h.errors_delta || 0), delta: null, color: parseFloat(errRate) > 5 ? 'var(--red)' : 'var(--green)' },
    { title: 'Uptime', value: '99.9%', spark: [], delta: null, color: 'var(--green)' },
  ];

  $('#kpi-row').innerHTML = kpis.map(k => `
    <div class="card">
      <div class="card-title">${k.title}</div>
      <div><span class="big-num" style="${k.color ? 'color:' + k.color : ''}">${k.value}</span>${k.delta != null ? `<span class="delta ${k.delta > 0 ? 'up' : k.delta < 0 ? 'down' : 'neutral'}">${k.delta > 0 ? 'â†‘' : k.delta < 0 ? 'â†“' : 'â€”'} ${Math.abs(k.delta)}</span>` : ''}</div>
      ${sparkSVG(k.spark)}
    </div>
  `).join('');

  // Ingestion chart
  renderChart('ch-ingestion', 'line', {
    labels: H.map(h => new Date(h.timestamp).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})),
    datasets: [{ label: 'Docs ingested', data: H.map(h => h.new_docs || 0), borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,.1)', fill: true, tension: .4 }]
  });

  // Source donut
  const src = ing.docs_by_source || {};
  renderChart('ch-sources', 'doughnut', {
    labels: Object.keys(src),
    datasets: [{ data: Object.values(src), backgroundColor: ['#3b82f6','#22c55e','#f59e0b','#ef4444','#a78bfa','#64748b'] }]
  }, { cutout: '65%' });

  // Mini cards
  const scrapers = D.scrapers || {};
  const activeSc = Object.entries(scrapers).filter(([k,v]) => k !== 'manuals' && v.status === 'running').length;
  const totalSc = Object.keys(scrapers).filter(k => k !== 'manuals').length;
  const lastScrape = Object.entries(scrapers).filter(([k]) => k !== 'manuals').reduce((best, [,v]) => {
    if (!v.last_scrape) return best;
    return !best || new Date(v.last_scrape) > new Date(best) ? v.last_scrape : best;
  }, null);

  $('#mini-row').innerHTML = `
    <div class="mini-card"><div class="icon" style="background:rgba(59,130,246,.12);color:var(--blue)">âš¡</div><div class="info"><div class="label">Latest scrape</div><div class="value">${ago(lastScrape)}</div></div></div>
    <div class="mini-card"><div class="icon" style="background:rgba(167,139,250,.12);color:var(--purple)">ðŸ“„</div><div class="info"><div class="label">Manuals discovered</div><div class="value">${fmt(scrapers.manuals?.discovered || 0)}</div></div></div>
    <div class="mini-card"><div class="icon" style="background:rgba(34,197,94,.12);color:var(--green)">ðŸ¤–</div><div class="info"><div class="label">Active scrapers</div><div class="value">${activeSc}/${totalSc}</div></div></div>
  `;

  // Feed
  renderFeedItems('overview-feed', generateFeedItems().slice(0, 10));
}

function renderIngestion() {
  const ing = D.ingestion || {};
  const stages = ['Source','Validate','Parse','Chunk','Embed','Store'];
  const total = ing.total_docs_ingested || 0;
  const throughputs = [total, Math.round(total*.98), Math.round(total*.96), Math.round(total*.95), Math.round(total*.94), total - (ing.total_errors||0)];

  $('#pipe-flow').innerHTML = stages.map((s, i) =>
    `${i ? '<div class="pipe-arrow">â†’</div>' : ''}<div class="pipe-stage"><div class="stage-name">${s}</div><div class="stage-val">${fmt(throughputs[i])}</div></div>`
  ).join('');

  $('#files-processed').textContent = fmt(ing.files_processed);
  $('#ing-errors').textContent = fmt(ing.total_errors);
  $('#queue-depth').textContent = '0';
  $('#dedup-rate').textContent = 'â€”';

  renderChart('ch-throughput', 'line', {
    labels: H.map(h => new Date(h.timestamp).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})),
    datasets: Object.keys(ing.docs_by_source||{}).map((src, i) => ({
      label: src, data: H.map(h => (h.docs_by_source||{})[src] || 0),
      borderColor: ['#3b82f6','#22c55e','#f59e0b','#ef4444','#a78bfa'][i],
      tension: .4, fill: false
    }))
  });

  renderChart('ch-stages', 'bar', {
    labels: stages,
    datasets: [{ label: 'Throughput', data: throughputs, backgroundColor: 'rgba(59,130,246,.6)', borderRadius: 4 }]
  });

  // Error log
  if (ing.total_errors > 0) {
    $('#error-log').innerHTML = '<div style="padding:20px;color:var(--text2);text-align:center">Error details not available in current snapshot</div>';
  } else {
    $('#error-log').innerHTML = '<div style="padding:20px;color:var(--text2);text-align:center">âœ… No recent errors</div>';
  }
}

function renderScrapers() {
  const scrapers = D.scrapers || {};
  const grid = $('#scraper-grid');
  grid.innerHTML = Object.entries(scrapers).filter(([k]) => k !== 'manuals').map(([name, s]) => {
    const docs = s.total_posts || s.total_docs || 0;
    return `<div class="scraper-card">
      <div class="sc-header"><span class="sc-name">${name}</span>${statusPill(s.status || 'stopped')}</div>
      <div class="sc-row"><span class="sc-label">Last scrape</span><span>${ago(s.last_scrape)}</span></div>
      <div class="sc-row"><span class="sc-label">Total docs</span><span>${fmt(docs)}</span></div>
      <div class="sc-row"><span class="sc-label">Errors</span><span>${s.errors || 0}</span></div>
      ${sparkSVG([docs * .6, docs * .7, docs * .85, docs * .92, docs], 120, 24)}
    </div>`;
  }).join('');

  const src = D.ingestion?.docs_by_source || {};
  renderChart('ch-by-source', 'bar', {
    labels: Object.keys(src).map(s => s.charAt(0).toUpperCase() + s.slice(1)),
    datasets: [{ label: 'Documents', data: Object.values(src), backgroundColor: ['#3b82f6','#22c55e','#f59e0b','#ef4444','#a78bfa'], borderRadius: 6 }]
  }, { indexAxis: 'y' });
}

function renderManuals() {
  const m = D.scrapers?.manuals || {};
  const steps = [
    { label: 'Discovered', val: m.discovered || 0, color: '#3b82f6' },
    { label: 'Downloaded', val: m.downloaded || 0, color: '#22c55e' },
    { label: 'Ingested', val: m.ingested || 0, color: '#a78bfa' },
    { label: 'Failed', val: m.failed || 0, color: '#ef4444' },
  ];
  const maxVal = Math.max(...steps.map(s => s.val), 1);
  $('#funnel').innerHTML = `<div class="funnel">${steps.map(s => {
    const w = Math.max(30, (s.val / maxVal) * 100);
    return `<div class="funnel-step" style="background:${s.color};width:${w}%"><span>${s.label}</span><span class="fs-num">${fmt(s.val)}</span></div>`;
  }).join('')}</div>`;

  $('#m-pdfs').textContent = fmt(m.ingested || 0);
  $('#m-disc').textContent = fmt(m.discovered || 0);
  $('#m-dl').textContent = fmt(m.downloaded || 0);
  $('#m-fail').textContent = fmt(m.failed || 0);

  if (!m.discovered) {
    $('#manuals-table').innerHTML = '<div class="empty-state"><svg viewBox="0 0 48 48" fill="none"><rect x="8" y="6" width="32" height="36" rx="3" stroke="currentColor" stroke-width="2"/><line x1="16" y1="16" x2="32" y2="16" stroke="currentColor" stroke-width="2"/><line x1="16" y1="22" x2="28" y2="22" stroke="currentColor" stroke-width="2"/></svg><p>No manuals discovered yet</p></div>';
  }
}

function renderGraph() {
  const kg = D.knowledge_graph || {};
  const nbt = kg.nodes_by_type || {};
  renderChart('ch-nodes-type', 'bar', {
    labels: Object.keys(nbt),
    datasets: [{ label: 'Nodes', data: Object.values(nbt), backgroundColor: '#3b82f6', borderRadius: 6 }]
  }, { indexAxis: 'y' });

  renderChart('ch-graph-growth', 'line', {
    labels: H.map(h => new Date(h.timestamp).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})),
    datasets: [
      { label: 'Nodes', data: H.map(h => h.total_nodes || 0), borderColor: '#3b82f6', tension: .4, fill: false },
      { label: 'Vectors', data: H.map(h => h.total_vectors || 0), borderColor: '#a78bfa', tension: .4, fill: false },
    ]
  });

  const makes = kg.top_makes || [];
  renderChart('ch-top-makes', 'bar', {
    labels: makes.map(m => m.name),
    datasets: [{ label: 'Documents', data: makes.map(m => m.documents), backgroundColor: '#3b82f6', borderRadius: 6 }]
  });

  // Tree
  const tree = $('#vehicle-tree');
  if (makes.length) {
    tree.innerHTML = makes.map(m => `
      <div class="tree-item" onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display==='none'?'block':'none'">
        <span class="toggle">â–¶</span> <strong>${m.name}</strong> â€” ${m.models} models, ${fmt(m.documents)} docs
      </div>
      <div class="tree-children" style="display:none"><div style="padding:8px 0;color:var(--text2);font-size:12px">Model details available in full dataset</div></div>
    `).join('');
  } else {
    tree.innerHTML = '<div class="empty-state"><p>No graph data available</p></div>';
  }
}

let allVehicles = [];
function renderVehicles() {
  const kg = D.knowledge_graph || {};
  allVehicles = kg.top_vehicles || [];

  renderChart('ch-top-vehicles', 'bar', {
    labels: allVehicles.slice(0, 10).map(v => v.vehicle),
    datasets: [
      { label: 'Documents', data: allVehicles.slice(0, 10).map(v => v.documents), backgroundColor: '#3b82f6', borderRadius: 4 },
      { label: 'Components', data: allVehicles.slice(0, 10).map(v => v.components), backgroundColor: 'rgba(167,139,250,.5)', borderRadius: 4 },
    ]
  });

  renderVehicleTable(allVehicles);
}

function renderVehicleTable(data) {
  if (!data.length) {
    $('#vehicles-table').innerHTML = '<div class="empty-state"><p>No vehicles found</p></div>';
    return;
  }
  $('#vehicles-table').innerHTML = `<table>
    <thead><tr><th>Vehicle</th><th>Documents</th><th>Components</th><th>Completeness</th></tr></thead>
    <tbody>${data.map(v => {
      const comp = Math.min(100, Math.round((v.documents / 50) * 100));
      return `<tr><td>${v.vehicle}</td><td>${v.documents}</td><td>${v.components}</td>
        <td><div style="display:flex;align-items:center;gap:8px"><div style="flex:1;height:6px;background:var(--border);border-radius:3px;overflow:hidden"><div style="height:100%;width:${comp}%;background:${comp > 60 ? 'var(--green)' : comp > 30 ? 'var(--amber)' : 'var(--red)'};border-radius:3px"></div></div><span style="font-size:11px;color:var(--text2)">${comp}%</span></div></td></tr>`;
    }).join('')}</tbody></table>`;
}

function filterVehicles() {
  const q = $('#veh-search').value.toLowerCase();
  renderVehicleTable(allVehicles.filter(v => v.vehicle.toLowerCase().includes(q)));
}

function renderServices() {
  const infra = D.infrastructure || {};
  const kg = D.knowledge_graph || {};
  const vs = D.vector_store || {};

  const services = [
    { name: 'Neo4j', icon: 'ðŸ”µ', status: infra.neo4j?.status, rows: [
      ['Version', infra.neo4j?.version || 'â€”'],
      ['Nodes', fmt(kg.total_nodes)],
      ['Relationships', fmt(kg.total_relationships)],
      ['Query Latency', 'N/A'],
    ]},
    { name: 'Qdrant', icon: 'ðŸŸ£', status: infra.qdrant?.status, rows: [
      ['Vectors', fmt(vs.total_vectors)],
      ['Collection', vs.collection || 'â€”'],
      ['Dimensions', vs.dimensions || 'â€”'],
      ['Size', 'N/A'],
    ]},
    { name: 'Ollama', icon: 'ðŸŸ¢', status: infra.ollama?.status, rows: [
      ['Model', infra.ollama?.model || 'â€”'],
      ['Embed Latency', 'N/A'],
    ]},
    { name: 'System Resources', icon: 'ðŸ’»', status: 'connected', rows: [
      ['CPU', 'N/A'],
      ['RAM', 'N/A'],
      ['Disk', 'N/A'],
    ]},
  ];

  $('#services-grid').innerHTML = services.map(s => `
    <div class="svc-card">
      <div class="svc-header"><span class="svc-name">${s.icon} ${s.name}</span>${statusPill(s.status || 'unknown')}</div>
      ${s.rows.map(([l, v]) => `<div class="svc-row"><span class="svc-label">${l}</span><span>${v}</span></div>`).join('')}
    </div>
  `).join('');
}

function generateFeedItems() {
  const items = [];
  // Generate from history
  H.forEach(h => {
    const ts = h.timestamp;
    if (h.new_docs > 0) items.push({ ts, type: 'ingestion', icon: 'ðŸ“¥', msg: `${h.new_docs} new documents ingested`, badge: 'ingestion' });
    if (h.new_nodes > 0) items.push({ ts, type: 'vehicles', icon: 'ðŸ”—', msg: `${h.new_nodes} new graph nodes created`, badge: 'graph' });
    if (h.new_vectors > 0) items.push({ ts, type: 'ingestion', icon: 'ðŸ§®', msg: `${h.new_vectors} new vectors embedded`, badge: 'vectors' });
    if (h.errors_delta > 0) items.push({ ts, type: 'errors', icon: 'âš ï¸', msg: `${h.errors_delta} errors occurred`, badge: 'error', error: true });
    Object.entries(h.docs_by_source || {}).forEach(([src, n]) => {
      if (n > 0) items.push({ ts, type: 'scrapers', icon: 'ðŸ¤–', msg: `${src}: ${n} docs scraped`, badge: src });
    });
  });
  // Add scraper status
  Object.entries(D.scrapers || {}).filter(([k]) => k !== 'manuals').forEach(([name, s]) => {
    if (s.last_scrape) items.push({ ts: s.last_scrape, type: 'scrapers', icon: 'âœ…', msg: `${name} scraper completed`, badge: name });
  });
  items.sort((a, b) => new Date(b.ts) - new Date(a.ts));
  return items;
}

function renderFeedItems(containerId, items) {
  const el = $(`#${containerId}`);
  if (!items.length) {
    el.innerHTML = '<div class="empty-state"><p>No activity yet</p></div>';
    return;
  }
  el.innerHTML = items.map(i => `
    <div class="feed-item${i.error ? ' error' : ''}">
      <div class="fi-icon">${i.icon}</div>
      <div class="fi-time">${ago(i.ts)}</div>
      <div class="fi-msg">${i.msg}</div>
      <span class="badge">${i.badge}</span>
    </div>
  `).join('');
}

function renderActivity() {
  const items = generateFeedItems();
  const filtered = activeFilter === 'all' ? items : items.filter(i => i.type === activeFilter);
  renderFeedItems('activity-feed', filtered);
}

function setFilter(f, btn) {
  activeFilter = f;
  $$('#activity-filters button').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderActivity();
}

// Chart helper
function renderChart(id, type, data, extraOpts = {}) {
  const canvas = $(`#${id}`);
  if (!canvas) return;
  if (charts[id]) charts[id].destroy();
  charts[id] = new Chart(canvas, {
    type,
    data,
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: data.datasets?.length > 1, labels: { color: '#64748b', font: { size: 11 } } },
      },
      scales: type === 'doughnut' ? {} : {
        x: { ticks: { color: '#64748b', font: { size: 10 } }, grid: { color: 'rgba(30,42,58,.5)' } },
        y: { ticks: { color: '#64748b', font: { size: 10 } }, grid: { color: 'rgba(30,42,58,.5)' } },
      },
      ...extraOpts,
    }
  });
}

// Countdown timer
function startCountdown() {
  cdLeft = 300;
  if (cdTimer) clearInterval(cdTimer);
  cdTimer = setInterval(() => {
    cdLeft--;
    if (cdLeft <= 0) {
      cdLeft = 0;
      updateCountdownUI();
      // Flash green
      $('#cd-ring').classList.add('done');
      setTimeout(() => { $('#cd-ring').classList.remove('done'); loadData(); cdLeft = 300; }, 1000);
      return;
    }
    updateCountdownUI();
  }, 1000);
  updateCountdownUI();
}
function updateCountdownUI() {
  const m = Math.floor(cdLeft / 60), s = cdLeft % 60;
  $('#cd-text').textContent = `${m}:${s.toString().padStart(2, '0')}`;
  const offset = CIRC * (1 - cdLeft / 300);
  $('#cd-ring').style.strokeDashoffset = offset;
}

// Relative time updater
setInterval(() => {
  if (D) { renderOverview(); renderScrapers(); renderActivity(); }
}, 60000);

// Init
route();
loadData();
startCountdown();
</script>
</body>
</html>