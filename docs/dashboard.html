<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Wessley AI ‚Äî Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
--bg:#0b0f15;--surface:#141a23;--surface2:#1c2430;--border:#232d3b;
--text:#e1e7ef;--text2:#6b7a8d;--blue:#4d8eff;--green:#34d399;
--amber:#fbbf24;--red:#f87171;--purple:#a78bfa;--sidebar-w:240px;--radius:10px;
}
html,body{height:100%;font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);overflow:hidden}
/* SIDEBAR */
.sidebar{position:fixed;top:0;left:0;bottom:0;width:var(--sidebar-w);background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;z-index:100;transition:transform .25s}
.sidebar-header{padding:20px 16px 12px;border-bottom:1px solid var(--border)}
.sidebar-header h1{font-size:16px;font-weight:700;display:flex;align-items:center;gap:8px}
.health-beacon{display:flex;align-items:center;gap:6px;font-size:11px;color:var(--green);margin-top:8px}
.health-beacon .dot{width:7px;height:7px;border-radius:50%;background:var(--green);animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.nav-section{padding:16px 12px 4px;font-size:10px;font-weight:600;color:var(--text2);letter-spacing:1.2px;text-transform:uppercase}
.sidebar nav{flex:1;overflow-y:auto;padding:4px 0}
.nav-item{display:flex;align-items:center;gap:10px;padding:9px 16px;font-size:13px;font-weight:500;color:var(--text2);cursor:pointer;border-left:3px solid transparent;transition:all .15s;text-decoration:none}
.nav-item:hover{color:var(--text);background:rgba(77,142,255,.06)}
.nav-item.active{color:var(--blue);border-left-color:var(--blue);background:rgba(77,142,255,.08)}
.sidebar-footer{padding:16px;border-top:1px solid var(--border);display:flex;flex-direction:column;align-items:center;gap:6px}
.countdown-ring{position:relative;width:50px;height:50px}
.countdown-ring svg{transform:rotate(-90deg)}
.countdown-ring circle{fill:none;stroke-width:3}
.countdown-ring .bg{stroke:var(--border)}
.countdown-ring .fg{stroke:var(--blue);stroke-linecap:round;transition:stroke-dashoffset .9s linear}
.countdown-text{font-size:11px;color:var(--text2)}
/* MOBILE */
.sidebar-toggle{display:none;position:fixed;top:12px;left:12px;z-index:200;background:var(--surface);border:1px solid var(--border);color:var(--text);border-radius:8px;padding:6px 10px;font-size:18px;cursor:pointer}
@media(max-width:800px){
.sidebar{transform:translateX(-100%)}
.sidebar.open{transform:translateX(0)}
.sidebar-toggle{display:block}
.main{margin-left:0!important}
}
/* MAIN */
.main{margin-left:var(--sidebar-w);height:100vh;overflow-y:auto;padding:24px 28px 40px}
.view{display:none}
.view.active{display:block}
/* CARDS */
.kpi-row{display:flex;gap:14px;flex-wrap:wrap;margin-bottom:20px}
.kpi-card{flex:1;min-width:150px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px;display:flex;flex-direction:column;gap:4px}
.kpi-card .label{font-size:11px;color:var(--text2);font-weight:500}
.kpi-card .value{font-size:26px;font-weight:700}
.kpi-card .delta{font-size:11px;font-weight:600;padding:2px 6px;border-radius:4px;display:inline-block;width:fit-content}
.delta.up{color:var(--green);background:rgba(52,211,153,.1)}
.delta.down{color:var(--red);background:rgba(248,113,113,.1)}
.delta.neutral{color:var(--text2);background:rgba(107,122,141,.1)}
.sparkline{margin-top:4px}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px}
.grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;margin-bottom:20px}
@media(max-width:900px){.grid-2,.grid-3{grid-template-columns:1fr}}
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:18px}
.card h3{font-size:13px;font-weight:600;color:var(--text2);margin-bottom:12px}
.chart-wrap{position:relative;height:220px}
.chart-wrap canvas{position:absolute;inset:0}
/* MINI CARDS */
.mini-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:14px;text-align:center}
.mini-card .mc-label{font-size:11px;color:var(--text2)}
.mini-card .mc-value{font-size:18px;font-weight:700;margin-top:4px}
/* TABLES */
.tbl{width:100%;border-collapse:collapse;font-size:12px;margin-top:8px}
.tbl th{text-align:left;color:var(--text2);font-weight:600;padding:6px 8px;border-bottom:1px solid var(--border)}
.tbl td{padding:6px 8px;border-bottom:1px solid var(--border);color:var(--text)}
/* PILLS */
.pill{display:inline-block;padding:2px 8px;border-radius:6px;font-size:10px;font-weight:600}
.pill.ok{background:rgba(52,211,153,.15);color:var(--green)}
.pill.err{background:rgba(248,113,113,.15);color:var(--red)}
.pill.warn{background:rgba(251,191,36,.15);color:var(--amber)}
/* PIPELINE */
.pipeline-flow{display:flex;gap:0;margin-bottom:20px;flex-wrap:wrap}
.pipeline-stage{flex:1;min-width:100px;background:var(--surface2);border:1px solid var(--border);padding:14px;text-align:center;position:relative}
.pipeline-stage:not(:last-child)::after{content:'‚Üí';position:absolute;right:-14px;top:50%;transform:translateY(-50%);color:var(--text2);font-size:16px;z-index:1}
.pipeline-stage .ps-name{font-size:11px;color:var(--text2);font-weight:600}
.pipeline-stage .ps-val{font-size:20px;font-weight:700;margin-top:4px}
/* SCRAPER CARDS */
.scraper-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:14px;margin-bottom:20px}
.scraper-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px}
.scraper-card .sc-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.scraper-card .sc-name{font-weight:600;font-size:14px}
.scraper-card .sc-stat{font-size:12px;color:var(--text2);margin-top:4px}
/* SERVICE CARDS */
.svc-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:16px;margin-bottom:20px}
.svc-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px;display:flex;align-items:center;gap:14px}
.svc-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}
.svc-dot.ok{background:var(--green)}
.svc-dot.err{background:var(--red)}
.svc-dot.warn{background:var(--amber)}
/* ACTIVITY */
.activity-filters{display:flex;gap:8px;margin-bottom:14px}
.af-pill{padding:5px 12px;border-radius:6px;font-size:12px;cursor:pointer;background:var(--surface2);color:var(--text2);border:1px solid var(--border);font-weight:500}
.af-pill.active{background:rgba(77,142,255,.15);color:var(--blue);border-color:var(--blue)}
.activity-list{max-height:500px;overflow-y:auto}
.activity-item{display:flex;gap:10px;padding:8px 0;border-bottom:1px solid var(--border);font-size:12px}
.activity-item .ai-time{color:var(--text2);min-width:70px;flex-shrink:0}
.activity-item .ai-icon{flex-shrink:0}
/* FUNNEL */
.funnel{display:flex;gap:8px;margin-bottom:16px;align-items:end}
.funnel-bar{border-radius:6px 6px 0 0;min-width:80px;text-align:center;padding:10px 12px;font-weight:700;font-size:18px}
.funnel-bar .fb-label{font-size:10px;font-weight:500;margin-top:4px}
.empty-state{text-align:center;padding:40px;color:var(--text2);font-size:13px}
.section-title{font-size:16px;font-weight:700;margin-bottom:16px}
</style>
</head>
<body>
<button class="sidebar-toggle" onclick="document.querySelector('.sidebar').classList.toggle('open')">‚ò∞</button>
<aside class="sidebar">
<div class="sidebar-header">
<h1>‚ö° Wessley AI</h1>
<div class="health-beacon"><span class="dot"></span> Live</div>
</div>
<nav>
<div class="nav-section">Monitor</div>
<a class="nav-item active" data-view="overview" href="#overview">üìä Overview</a>
<a class="nav-item" data-view="pipeline" href="#pipeline">üîÑ Pipeline</a>
<a class="nav-item" data-view="scrapers" href="#scrapers">üï∑Ô∏è Scrapers</a>
<div class="nav-section">Knowledge</div>
<a class="nav-item" data-view="graph" href="#graph">üß† Graph</a>
<a class="nav-item" data-view="vehicles" href="#vehicles">üöó Vehicles</a>
<a class="nav-item" data-view="manuals" href="#manuals">üìñ Manuals</a>
<div class="nav-section">System</div>
<a class="nav-item" data-view="infra" href="#infra">üñ•Ô∏è Infrastructure</a>
<a class="nav-item" data-view="activity" href="#activity">üìã Activity</a>
</nav>
<div class="sidebar-footer">
<div class="countdown-ring">
<svg width="50" height="50" viewBox="0 0 50 50">
<circle class="bg" cx="25" cy="25" r="21"/>
<circle class="fg" id="cd-ring" cx="25" cy="25" r="21" stroke-dasharray="131.95" stroke-dashoffset="0"/>
</svg>
</div>
<div class="countdown-text" id="cd-text">Next: 5:00</div>
</div>
</aside>

<main class="main">
<!-- OVERVIEW -->
<div class="view active" id="v-overview">
<div class="section-title">Overview</div>
<div class="kpi-row" id="overview-kpis"></div>
<div class="grid-2">
<div class="card"><h3>Ingestion Rate (24h)</h3><div class="chart-wrap"><canvas id="ch-ingestion-rate"></canvas></div></div>
<div class="card"><h3>By Source</h3><div class="chart-wrap"><canvas id="ch-by-source"></canvas></div></div>
</div>
<div class="grid-3" id="overview-minis"></div>
</div>
<!-- PIPELINE -->
<div class="view" id="v-pipeline">
<div class="section-title">Ingestion Pipeline</div>
<div class="pipeline-flow" id="pipeline-stages"></div>
<div class="grid-2">
<div class="card"><h3>Throughput (24h)</h3><div class="chart-wrap"><canvas id="ch-throughput"></canvas></div></div>
<div class="card"><h3>Error Rate (24h)</h3><div class="chart-wrap"><canvas id="ch-error-rate"></canvas></div></div>
</div>
<div class="kpi-row" id="pipeline-stats"></div>
</div>
<!-- SCRAPERS -->
<div class="view" id="v-scrapers">
<div class="section-title">Scraper Status</div>
<div class="scraper-grid" id="scraper-cards"></div>
<div class="card"><h3>Documents by Source</h3><div class="chart-wrap"><canvas id="ch-scraper-bars"></canvas></div></div>
</div>
<!-- GRAPH -->
<div class="view" id="v-graph">
<div class="section-title">Knowledge Graph</div>
<div class="kpi-row" id="graph-kpis"></div>
<div class="grid-2">
<div class="card"><h3>Nodes by Type</h3><div class="chart-wrap"><canvas id="ch-nodes-type"></canvas></div></div>
<div class="card"><h3>Relationships by Type</h3><div class="chart-wrap"><canvas id="ch-rels-type"></canvas></div></div>
</div>
<div class="grid-2">
<div class="card"><h3>Top Makes</h3><table class="tbl"><thead><tr><th>Make</th><th>Models</th><th>Docs</th></tr></thead><tbody id="tbl-makes"></tbody></table></div>
<div class="card"><h3>Top Vehicles</h3><table class="tbl"><thead><tr><th>Vehicle</th><th>Docs</th><th>Components</th></tr></thead><tbody id="tbl-vehicles"></tbody></table></div>
</div>
</div>
<!-- VEHICLES -->
<div class="view" id="v-vehicles">
<div class="section-title">Vehicle Coverage</div>
<div class="kpi-row" id="vehicles-kpis"></div>
<div class="grid-2">
<div class="card"><h3>Top Vehicles by Docs</h3><div class="chart-wrap"><canvas id="ch-top-vehicles"></canvas></div></div>
<div class="card"><h3>Top Makes</h3><div class="chart-wrap"><canvas id="ch-top-makes"></canvas></div></div>
</div>
</div>
<!-- MANUALS -->
<div class="view" id="v-manuals">
<div class="section-title">Manual Tracker</div>
<div id="manuals-content"></div>
</div>
<!-- INFRA -->
<div class="view" id="v-infra">
<div class="section-title">Infrastructure</div>
<div class="svc-grid" id="infra-cards"></div>
</div>
<!-- ACTIVITY -->
<div class="view" id="v-activity">
<div class="section-title">Activity Feed</div>
<div class="activity-filters" id="activity-filters"></div>
<div class="activity-list" id="activity-list"></div>
</div>
</main>

<script>
let DATA=null, HISTORY=[], lastTs=null;
const charts={};

function mkChart(id,type,data,opts={}){
  const el=document.getElementById(id);
  if(!el)return;
  if(charts[id]){charts[id].destroy();charts[id]=null}
  charts[id]=new Chart(el,{type,data,options:{
    responsive:true,maintainAspectRatio:false,animation:{duration:300},
    plugins:{legend:{labels:{color:'#6b7a8d',font:{size:11,family:'Inter'}}}},
    scales:type==='doughnut'||type==='pie'?{}:{
      x:{ticks:{color:'#4a5568',font:{size:10}},grid:{color:'rgba(35,45,59,.5)'}},
      y:{ticks:{color:'#4a5568',font:{size:10}},grid:{color:'rgba(35,45,59,.5)'},beginAtZero:true}
    },...opts}});
}

function num(v){if(v==null)return'‚Äî';if(v>=1e6)return(v/1e6).toFixed(1)+'M';if(v>=1e3)return(v/1e3).toFixed(1)+'K';return v.toLocaleString()}
function ago(ts){if(!ts)return'‚Äî';const d=Date.now()-new Date(ts).getTime(),m=Math.floor(d/60000);if(m<1)return'just now';if(m<60)return m+'m ago';const h=Math.floor(m/60);if(h<24)return h+'h ago';return Math.floor(h/24)+'d ago'}

function sparkSVG(arr){
  if(!arr||arr.length<2)return'';
  const w=60,h=20,max=Math.max(...arr)||1,min=Math.min(...arr);
  const pts=arr.map((v,i)=>`${(i/(arr.length-1))*w},${h-((v-min)/(max-min||1))*h}`).join(' ');
  return`<svg class="sparkline" width="${w}" height="${h}" viewBox="0 0 ${w} ${h}"><polyline points="${pts}" fill="none" stroke="var(--blue)" stroke-width="1.5"/></svg>`;
}

function kpiCard(label,value,delta,hist){
  const cls=delta>0?'up':delta<0?'down':'neutral';
  const sign=delta>0?'+':'';
  return`<div class="kpi-card"><div class="label">${label}</div><div class="value">${num(value)}</div>${delta!=null?`<div class="delta ${cls}">${sign}${delta}</div>`:''}${sparkSVG(hist)}</div>`;
}

function histField(field){
  return HISTORY.slice(-12).map(h=>{
    try{return field.split('.').reduce((o,k)=>o[k],h)||0}catch(e){return 0}
  });
}

// RENDERERS
const renderers={
overview(){
  if(!DATA)return;
  const ig=DATA.ingestion||{},kg=DATA.knowledge_graph||{},vs=DATA.vector_store||{};
  const srcCount=Object.keys(DATA.scrapers||{}).filter(k=>k!=='manuals'&&(DATA.scrapers[k].status==='active'||DATA.scrapers[k].total_posts>0)).length;
  const errRate=ig.total_docs_ingested?(ig.total_errors/ig.total_docs_ingested*100).toFixed(1)+'%':'0%';
  document.getElementById('overview-kpis').innerHTML=[
    kpiCard('Total Docs',ig.total_docs_ingested||0,null,histField('ingestion.total_docs_ingested')),
    kpiCard('Graph Nodes',kg.total_nodes||0,null,histField('knowledge_graph.total_nodes')),
    kpiCard('Vectors',vs.total_vectors||0,null,histField('vector_store.total_vectors')),
    kpiCard('Error Rate',errRate),
    kpiCard('Sources Active',srcCount)
  ].join('');

  // ingestion rate chart
  const hLabels=HISTORY.slice(-24).map((_,i)=>i+'h');
  const hData=HISTORY.slice(-24).map(h=>h?.ingestion?.total_docs_ingested||0);
  mkChart('ch-ingestion-rate','line',{labels:hLabels,datasets:[{label:'Docs',data:hData,borderColor:'var(--blue)',backgroundColor:'rgba(77,142,255,.1)',fill:true,tension:.3,pointRadius:0}]});

  // by source doughnut
  const src=ig.docs_by_source||{};
  const sKeys=Object.keys(src), sVals=sKeys.map(k=>src[k]);
  const colors=['#4d8eff','#34d399','#fbbf24','#f87171','#a78bfa','#f472b6','#fb923c'];
  mkChart('ch-by-source','doughnut',{labels:sKeys,datasets:[{data:sVals,backgroundColor:colors.slice(0,sKeys.length)}]});

  // mini cards
  const sc=DATA.scrapers||{};
  const lastScrape=Object.values(sc).reduce((a,s)=>s.last_scrape&&new Date(s.last_scrape)>new Date(a||0)?s.last_scrape:a,null);
  const man=sc.manuals||{};
  document.getElementById('overview-minis').innerHTML=`
    <div class="mini-card"><div class="mc-label">Last Scrape</div><div class="mc-value">${ago(lastScrape)}</div></div>
    <div class="mini-card"><div class="mc-label">Manuals Discovered</div><div class="mc-value">${num(man.discovered||0)}</div></div>
    <div class="mini-card"><div class="mc-label">Files Processed</div><div class="mc-value">${num(ig.files_processed||0)}</div></div>`;
},

pipeline(){
  if(!DATA)return;
  const ig=DATA.ingestion||{};
  const stages=['Validate','Parse','Chunk','Embed','Store'];
  document.getElementById('pipeline-stages').innerHTML=stages.map(s=>`<div class="pipeline-stage"><div class="ps-name">${s}</div><div class="ps-val">‚Äî</div></div>`).join('');
  
  const hLabels=HISTORY.slice(-24).map((_,i)=>i+'h');
  mkChart('ch-throughput','line',{labels:hLabels,datasets:[{label:'Docs/h',data:HISTORY.slice(-24).map(h=>h?.ingestion?.total_docs_ingested||0),borderColor:'var(--blue)',tension:.3,pointRadius:0,fill:true,backgroundColor:'rgba(77,142,255,.08)'}]});
  mkChart('ch-error-rate','line',{labels:hLabels,datasets:[{label:'Errors',data:HISTORY.slice(-24).map(h=>h?.ingestion?.total_errors||0),borderColor:'var(--red)',tension:.3,pointRadius:0,fill:true,backgroundColor:'rgba(248,113,113,.08)'}]});
  
  document.getElementById('pipeline-stats').innerHTML=[
    kpiCard('Total Ingested',ig.total_docs_ingested||0),
    kpiCard('Total Errors',ig.total_errors||0),
    kpiCard('Files Processed',ig.files_processed||0)
  ].join('');
},

scrapers(){
  if(!DATA)return;
  const sc=DATA.scrapers||{};
  const names=['reddit','nhtsa','ifixit','youtube'];
  document.getElementById('scraper-cards').innerHTML=names.map(n=>{
    const s=sc[n]||{};
    const st=s.status||'unknown';
    const cls=st==='active'?'ok':st==='error'?'err':'warn';
    return`<div class="scraper-card"><div class="sc-header"><span class="sc-name">${n}</span><span class="pill ${cls}">${st}</span></div><div class="sc-stat">${num(s.total_posts||s.total_docs||0)} docs</div><div class="sc-stat">Last: ${ago(s.last_scrape)}</div></div>`;
  }).join('');
  
  const labels=names,vals=names.map(n=>(sc[n]||{}).total_posts||(sc[n]||{}).total_docs||0);
  mkChart('ch-scraper-bars','bar',{labels,datasets:[{label:'Documents',data:vals,backgroundColor:'#4d8eff'}]},{indexAxis:'y'});
},

graph(){
  if(!DATA)return;
  const kg=DATA.knowledge_graph||{};
  const nbt=kg.nodes_by_type||{},rbt=kg.relationships_by_type||{};
  document.getElementById('graph-kpis').innerHTML=[
    kpiCard('Total Nodes',kg.total_nodes||0),
    kpiCard('Total Relationships',kg.total_relationships||0),
    kpiCard('Node Types',Object.keys(nbt).length),
    kpiCard('Rel Types',Object.keys(rbt).length)
  ].join('');
  
  mkChart('ch-nodes-type','bar',{labels:Object.keys(nbt),datasets:[{label:'Nodes',data:Object.values(nbt),backgroundColor:'#4d8eff'}]},{indexAxis:'y'});
  mkChart('ch-rels-type','bar',{labels:Object.keys(rbt),datasets:[{label:'Rels',data:Object.values(rbt),backgroundColor:'#a78bfa'}]},{indexAxis:'y'});
  
  const makes=(kg.top_makes||[]).slice(0,10);
  document.getElementById('tbl-makes').innerHTML=makes.map(m=>`<tr><td>${m.name||''}</td><td>${m.models||0}</td><td>${m.documents||0}</td></tr>`).join('')||'<tr><td colspan=3 style="color:var(--text2)">No data</td></tr>';
  const vehs=(kg.top_vehicles||[]).slice(0,10);
  document.getElementById('tbl-vehicles').innerHTML=vehs.map(v=>`<tr><td>${v.vehicle||''}</td><td>${v.documents||0}</td><td>${v.components||0}</td></tr>`).join('')||'<tr><td colspan=3 style="color:var(--text2)">No data</td></tr>';
},

vehicles(){
  if(!DATA)return;
  const kg=DATA.knowledge_graph||{};
  const makes=kg.top_makes||[],vehs=kg.top_vehicles||[];
  document.getElementById('vehicles-kpis').innerHTML=[
    kpiCard('Total Makes',makes.length),
    kpiCard('Total Vehicles',vehs.length)
  ].join('');
  const topV=vehs.slice(0,10);
  mkChart('ch-top-vehicles','bar',{labels:topV.map(v=>v.vehicle),datasets:[{label:'Docs',data:topV.map(v=>v.documents||0),backgroundColor:'#4d8eff'}]},{indexAxis:'y'});
  const topM=makes.slice(0,10);
  mkChart('ch-top-makes','bar',{labels:topM.map(m=>m.name),datasets:[{label:'Models',data:topM.map(m=>m.models||0),backgroundColor:'#34d399'}]},{indexAxis:'y'});
},

manuals(){
  if(!DATA)return;
  const m=(DATA.scrapers||{}).manuals||{};
  if(!m.discovered&&!m.downloaded&&!m.ingested){
    document.getElementById('manuals-content').innerHTML='<div class="empty-state">üìñ Manual crawling not yet started.<br>Run <code>--manuals-discover</code> to begin.</div>';
    return;
  }
  const maxV=Math.max(m.discovered||0,m.downloaded||0,m.ingested||0,1);
  const bar=(v,c,l)=>`<div class="funnel-bar" style="background:${c};height:${Math.max(40,v/maxV*120)}px">${v}<div class="fb-label">${l}</div></div>`;
  document.getElementById('manuals-content').innerHTML=`
    <div class="funnel">${bar(m.discovered||0,'rgba(77,142,255,.3)','Discovered')}${bar(m.downloaded||0,'rgba(52,211,153,.3)','Downloaded')}${bar(m.ingested||0,'rgba(167,139,250,.3)','Ingested')}</div>
    <div class="kpi-row">${kpiCard('Discovered',m.discovered||0)}${kpiCard('Downloaded',m.downloaded||0)}${kpiCard('Ingested',m.ingested||0)}${kpiCard('Failed',m.failed||0)}</div>`;
},

infra(){
  if(!DATA)return;
  const inf=DATA.infrastructure||{};
  const svcs=[
    {key:'neo4j',icon:'üóÑÔ∏è',detail:s=>`Version: ${s.version||'‚Äî'}`},
    {key:'qdrant',icon:'üîÆ',detail:s=>`Vectors: ${num(s.vectors||0)}`},
    {key:'ollama',icon:'ü§ñ',detail:s=>`Model: ${s.model||'‚Äî'}`}
  ];
  document.getElementById('infra-cards').innerHTML=svcs.map(({key,icon,detail})=>{
    const s=inf[key]||{};
    const st=s.status||'unknown';
    const cls=st==='connected'||st==='running'||st==='healthy'?'ok':st==='error'?'err':'warn';
    return`<div class="svc-card"><div class="svc-dot ${cls}"></div><div><div style="font-weight:600">${icon} ${key}</div><div style="font-size:12px;color:var(--text2);margin-top:4px">${detail(s)}</div><div style="font-size:11px;color:var(--text2)">Status: ${st}</div></div></div>`;
  }).join('');
},

activity(){
  const filters=['All','Ingestion','Errors','Vehicles'];
  document.getElementById('activity-filters').innerHTML=filters.map((f,i)=>`<div class="af-pill${i===0?' active':''}" data-filter="${f.toLowerCase()}">${f}</div>`).join('');
  
  const items=HISTORY.slice(-50).reverse().map(h=>{
    const ts=h?.timestamp?new Date(h.timestamp).toLocaleTimeString():'';
    const docs=h?.ingestion?.total_docs_ingested;
    const errs=h?.ingestion?.total_errors;
    let icon='üìä',msg='Metrics snapshot',cat='all';
    if(errs>0){icon='‚ùå';msg=`${errs} errors recorded`;cat='errors'}
    else if(docs>0){icon='üì•';msg=`${docs} docs ingested`;cat='ingestion'}
    return`<div class="activity-item" data-cat="${cat}"><span class="ai-time">${ts}</span><span class="ai-icon">${icon}</span><span>${msg}</span></div>`;
  });
  document.getElementById('activity-list').innerHTML=items.join('')||'<div class="empty-state">No activity yet</div>';
  
  document.querySelectorAll('.af-pill').forEach(p=>p.onclick=function(){
    document.querySelectorAll('.af-pill').forEach(x=>x.classList.remove('active'));
    this.classList.add('active');
    const f=this.dataset.filter;
    document.querySelectorAll('.activity-item').forEach(el=>{
      el.style.display=(f==='all'||el.dataset.cat===f)?'flex':'none';
    });
  });
}
};

function currentView(){return location.hash.slice(1)||'overview'}
function renderCurrentView(){const v=currentView();if(renderers[v])renderers[v]()}

// NAV
function navigate(){
  const hash=currentView();
  document.querySelectorAll('.view').forEach(v=>v.classList.toggle('active',v.id==='v-'+hash));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.toggle('active',n.dataset.view===hash));
  document.querySelector('.sidebar').classList.remove('open');
  renderCurrentView();
}
window.addEventListener('hashchange',navigate);

// DATA
async function loadData(){
  const[latest,history]=await Promise.all([
    fetch('data/metrics-latest.json?'+Date.now()).then(r=>r.json()).catch(()=>null),
    fetch('data/metrics-history.json?'+Date.now()).then(r=>r.json()).catch(()=>[])
  ]);
  if(!latest)return;
  if(latest.timestamp===lastTs)return;
  lastTs=latest.timestamp;
  DATA=latest;HISTORY=history;
  renderCurrentView();
}
setInterval(loadData,30000);

// COUNTDOWN
let cdLeft=300;
function tickCountdown(){
  cdLeft--;
  if(cdLeft<=0){cdLeft=300;loadData()}
  const m=Math.floor(cdLeft/60),s=cdLeft%60;
  document.getElementById('cd-text').textContent=`Next: ${m}:${s.toString().padStart(2,'0')}`;
  const circ=131.95;
  document.getElementById('cd-ring').style.strokeDashoffset=circ*(1-cdLeft/300);
}
setInterval(tickCountdown,1000);

// INIT
loadData();
navigate();
</script>
</body>
</html>
